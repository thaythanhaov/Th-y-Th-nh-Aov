<!DOCTYPE html>
<html lang="vi" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Th·∫ßy Th√†nh Aov + Shop Uy T√≠n S·ªë 1 Sever</title>
  <meta name="description" content="Website B√°n Tool DangKhoa_Dev. Tool T·∫°i Website C√≥ Th·ªÉ Mua T·∫°i Ch√≠nh Trang Web N√†y Qua Thanh To√°n" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
    :root{
      /* Brand Colors - Adjusted to match eki.my.id's vibrant purples, blues, greens */
      --brand1:#AE67FA; /* Lighter Purple */
      --brand2:#F49867; /* Orange */
      --brand3:#56D7C8; /* Teal Green */
      --brand4:#7873F5; /* Deeper Purple */
      --brand5:#34B0F5; /* Bright Blue */

      /* Dark Theme */
      --bg-dark:#0B0E16; /* Darker Background */
      --panel-dark:rgba(255,255,255,.06); /* Slightly more opaque glass */
      --txt-dark:#e6eef8; /* Light text for dark background */

      /* Light Theme (Fallbacks, not primary focus for eki.my.id style) */
      --bg-light:#f6f7fb;
      --panel-light:#ffffff;
      --txt-light:#0b1220;

      /* Glassmorphism Elements */
      --glass: rgba(255,255,255,0.08); /* Base glass effect */
      --glass-2: rgba(255,255,255,0.12); /* Stronger glass effect */
      --glass-border: rgba(255,255,255,0.15); /* Glass border */

      /* Muted Text */
      --muted-dark:#9fb0d4;
      --muted-light:#6b7280;

      /* Accent & Status Colors */
      --accent:var(--brand3); /* Teal Green accent */
      --danger:#ef4444;
      --warn:#f59e0b;

      /* Particle Effect Colors */
      --particle-color: rgba(68, 221, 238, 0.7); /* Cyan */
      --line-color: rgba(120, 115, 245, 0.4); /* Purple */
    }
    html{
        background: linear-gradient(135deg, var(--bg-dark), #1c202e);
        color: var(--txt-dark);
        transition: background-color 0.3s ease, color 0.3s ease;
        scroll-behavior: smooth;
    }
    html[data-theme='light']{
        background: linear-gradient(135deg, var(--bg-light), #e0e2e8);
        color: var(--txt-light);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:'Inter',ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,'Helvetica Neue',Arial,'Courier New',monospace;min-height:100vh; overflow-x: hidden;}

    /* Navbar */
    .navbar{position:fixed;inset-inline:0;top:0;height:72px;display:flex;align-items:center;justify-content:center;z-index:40;padding:0 18px;background:linear-gradient(180deg,rgba(0,0,0,.35),transparent);backdrop-filter:blur(12px);
    box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }
    .nav-inner{max-width:100%;
    width:100%;display:flex;align-items:center;justify-content:space-between;
    padding-inline: 40px;
    }
    @media(max-width:1200px){.nav-inner{padding-inline: 18px;}} /* Reduced padding for mobile */

    .brand{display:flex;gap:8px;align-items:center;font-weight:900;font-size:1.35rem;
    color: var(--txt-dark);
    }
    .brand .logo{width:40px;height:40px;border-radius:10px;
    background:conic-gradient(from 90deg,var(--brand1),var(--brand5));box-shadow:0 6px 20px rgba(0,0,0,.3);
    }
    .brand-text {
        background:linear-gradient(90deg,var(--brand3),var(--brand4));
        -webkit-background-clip:text;
        -webkit-text-fill-color:transparent;
    }

    /* Nav Links in Header (for desktop) */
    .header-nav-links {
        display: flex;
        gap: 25px;
        margin-left: auto;
        margin-right: 25px;
    }
    .header-nav-links a {
        color: var(--muted-dark);
        text-decoration: none;
        font-weight: 600;
        font-size: 1rem;
        transition: color 0.2s ease, text-shadow 0.2s ease;
    }
    .header-nav-links a:hover {
        color: var(--brand3);
        text-shadow: 0 0 8px var(--brand3);
    }
    .header-nav-links a.active {
        color: var(--brand5);
        text-shadow: 0 0 10px var(--brand5);
    }
    @media (max-width: 1200px) {
        .header-nav-links {
            display: none;
        }
    }


    .cta{display:flex;gap:14px;align-items:center}
    .btn{border:0;padding:12px 18px;border-radius:12px;cursor:pointer;font-weight:700;transition:transform .2s, box-shadow .2s, background .2s;
    text-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .btn:hover{transform:translateY(-3px);box-shadow:0 12px 25px rgba(0,0,0,.25)}
    .btn-glass{background:var(--glass);color:inherit;backdrop-filter:blur(10px);border:1px solid var(--glass-border);
    }
    .btn-glass:hover{background:var(--glass-2);}
    .btn-primary{background:linear-gradient(90deg,var(--brand1),var(--brand4));color:#fff;box-shadow:0 8px 20px rgba(174,103,250,.3);
    border:1px solid rgba(174,103,250,.3);
    }
    .btn-primary:hover{background:linear-gradient(90deg,var(--brand4),var(--brand1));}
    .btn-danger{background:linear-gradient(90deg,#f43f5e,#fb923c);color:#fff}
    .btn-success{background:linear-gradient(90deg,#10b981,#06b6d4);color:#fff}

    /* Site grid & Mobile menu */
    .site-wrap{max-width:100%;
    margin:90px auto 40px;
    display:grid;
    grid-template-columns:220px 1fr 260px; /* Adjusted sidebar sizes for wider main content */
    gap:28px;
    padding-inline:40px;
    }
    @media(max-width:1200px){.site-wrap{grid-template-columns:1fr;grid-auto-rows:min-content;padding:0 18px}}
    
    .side-menu{position:fixed;
    top:0;left:0;height:100%;width:280px;transform:translateX(-100%);padding-top:0;
    background: rgba(11, 14, 22, 0.9);
    backdrop-filter: blur(15px);
    box-shadow:0 0 40px rgba(0,0,0,.7);z-index:90;overflow-y:auto;
    border-radius: 0 20px 20px 0;
    transition:transform .3s ease-in-out;
    }
    .side-menu.active{transform:translateX(0)}

    .side-menu .brand-in-menu {
        display: flex;
        padding: 20px 22px;
        font-size: 1.5rem;
        font-weight: 900;
        background:linear-gradient(90deg,var(--brand3),var(--brand4)); -webkit-background-clip:text; -webkit-text-fill-color:transparent;
        align-items: center;
        gap: 12px;
        border-bottom: 1px solid rgba(255,255,255,.1);
        margin-bottom: 15px;
    }
    .side-menu .brand-in-menu .logo {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        background: conic-gradient(from 90deg,var(--brand1),var(--brand2),var(--brand3),var(--brand4));
        box-shadow:0 8px 30px rgba(0,0,0,.35);
    }
    
    /* New: Mobile auth/admin buttons inside side menu */
    .side-menu-auth-actions {
        display: none; /* Hidden by default, shown on mobile */
        flex-direction: column;
        gap: 10px;
        padding: 10px 22px 20px;
        border-bottom: 1px solid rgba(255,255,255,.1);
        margin-bottom: 15px;
    }
    .side-menu-auth-actions .btn {
        width: 100%;
        text-align: center;
    }
    .side-menu-auth-actions .btn-logout {
        display: none; /* Initially hidden, controlled by JS */
    }

    @media (max-width: 1200px) {
        /* Hide auth buttons from main navbar on mobile */
        .navbar .cta .btn-glass,
        .navbar .cta .btn-primary:not(#btnLogout) { /* Exclude logout button if it was there */
            display: none;
        }
        /* Show mobile auth/admin actions in side menu */
        .side-menu-auth-actions {
            display: flex;
        }
        /* Adjust theme toggle for mobile if it needs specific placement */
        .navbar .cta label {
            margin-left: auto; /* Push it to the right */
        }
    }


    .side-menu a{display:flex;align-items:center;gap:14px;padding:14px;border-radius:14px;
    text-decoration:none;color:inherit;font-weight:600;margin:0 22px 10px;
    transition:background .2s, transform .2s, color .2s;
    }
    .side-menu a:hover{transform:translateX(6px);background:rgba(255,255,255,.06); color: var(--brand2);}
    .side-menu a.active{background:linear-gradient(90deg,var(--brand1),var(--brand4));color:#fff;box-shadow:0 4px 15px rgba(120,80,200,.2);}
    
    .mobile-menu-btn{
        display: block;
        font-size:1.8rem;
        background:transparent;
        border:none;
        color:inherit;
        cursor:pointer;
        transition:transform .2s;
        padding: 5px 10px; /* Added padding for easier touch target */
        margin-right: 15px; /* Space from brand logo */
    }
    .mobile-menu-btn:active{transform:scale(0.9);}

    @media(max-width:1200px){
      .overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:80;}
      .overlay.active{display:block}
    }

    /* Explicitly place grid items on larger screens */
    @media (min-width: 1201px) {
        .side-menu {
            grid-column: 1 / 2;
            position: static; /* Ensure it stays in its grid column on desktop */
            width: 220px; /* Fixed width for desktop */
            transform: translateX(0); /* Ensure it's always visible */
            background: transparent; /* No background filter, takes theme background */
            backdrop-filter: none;
            box-shadow: none;
            border-radius: 0;
            overflow-y: visible;
            padding-top: 20px; /* Adjust padding if needed */
        }
        .main {
            grid-column: 2 / 3;
        }
        .sidebar {
            grid-column: 3 / 4;
            position: static; /* Force it to stay in document flow within grid */
            top: auto; /* Remove top property */
        }
        /* Hide mobile menu button on desktop */
        .mobile-menu-btn {
            display: none;
        }
        /* Adjust brand in menu for desktop */
        .side-menu .brand-in-menu {
            display: none; /* Hide brand in menu when it's desktop sidebar */
        }
        .side-menu a {
            margin: 0 0 10px 0; /* Remove horizontal margin for cleaner look */
        }
        .side-menu-auth-actions {
            display: none; /* Hide these on desktop */
        }
    }


    /* Main content */
    .main{padding:24px;
    background:var(--panel-dark);border-radius:20px;
    box-shadow:0 8px 30px rgba(0,0,0,.3);
    backdrop-filter: blur(10px);
    border:1px solid var(--glass-border);
    }
    html[data-theme='light'] .main{background:var(--panel-light);box-shadow:0 8px 30px rgba(0,0,0,.1);}
    
    .welcome-card{padding:0;
    border-radius:20px;
    background: transparent;
    backdrop-filter:none;
    display:flex;align-items:center;justify-content:center;
    box-shadow: none;
    border:none;
    width: 100%;
    height: 450px;
    max-width: 100%;
    margin: 0 auto;
    position: relative;
    overflow: hidden;
    }
    html[data-theme='light'] .welcome-card{background: transparent;}
    .welcome-title, .welcome-sub {
        display: none;
    }
    .welcome-left {
        display: none;
    }

    /* Existing banner styling */
    .banner-vip-container {
        width: 100%;
        height: 100%;
        position: relative;
        border-radius: 16px;
        overflow: hidden;
        background: #0d0d1a;
        box-shadow: 0 10px 30px rgba(0,0,0,0.4);
        border: 1px solid var(--glass-border);
    }
    .banner-vip-container img {
        display: none;
    }
    .banner-vip-container canvas {
        position: absolute;
        inset: 0;
        display: block;
        z-index: 1;
    }
    .banner-vip-overlay {
        position: absolute;
        inset: 0;
        background: rgba(0,0,0,0.3);
        border-radius: 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 40px 60px;
        gap: 40px;
        flex-wrap: wrap;
        height: 100%;
        z-index: 2;
        backdrop-filter: blur(8px) brightness(1.1);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .banner-vip-overlay:hover {
        transform: scale(1.005);
        box-shadow: 0 15px 40px rgba(0,0,0,0.4);
    }

    /* Styling for the new banner content */
    .banner-content-left {
        flex: 1;
        min-width: 300px;
        text-align: left;
    }

    .banner-illustration-right {
        flex: 1;
        display: flex;
        justify-content: center;
        align-items: center;
        max-width: 400px;
        min-width: 250px;
    }

    .banner-illustration-right img {
        width: 100%;
        height: auto;
        object-fit: contain;
        filter: drop-shadow(0 0 20px rgba(120,115,245,0.6));
    }

    .banner-tag {
        background: rgba(255,255,255,0.1);
        backdrop-filter: blur(5px);
        border: 1px solid rgba(255,255,255,0.2);
        border-radius: 10px;
        padding: 6px 12px;
        font-size: 0.85rem;
        font-weight: 600;
        color: #fff;
        display: inline-block;
        margin-bottom: 15px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    .banner-main-title {
        font-size: 3.2rem;
        font-weight: 900;
        background: linear-gradient(90deg, var(--brand3), var(--brand5));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin: 0 0 5px 0;
        line-height: 1.1;
        filter: drop-shadow(0 0 10px rgba(34,211,238,0.7));
    }

    .banner-subtitle {
        font-size: 1.8rem;
        font-weight: 700;
        color: var(--brand4);
        margin: 0 0 10px 0;
        filter: drop-shadow(0 0 5px rgba(120,115,245,0.5));
    }

    .banner-description {
        font-size: 1.0rem;
        color: rgba(255,255,255,0.8);
        margin-bottom: 25px;
        max-width: 450px;
        line-height: 1.5;
    }

    .banner-skills {
        display: flex;
        gap: 12px;
        margin-bottom: 25px;
        flex-wrap: wrap;
    }

    .skill-tag {
        background: rgba(255,255,255,0.08);
        backdrop-filter: blur(3px);
        border: 1px solid var(--glass-border);
        border-radius: 8px;
        padding: 6px 12px;
        font-size: 0.85rem;
        font-weight: 500;
        color: var(--brand5);
        transition: background 0.2s ease;
    }
    .skill-tag:hover {
        background: rgba(255,255,255,0.15);
        color: #fff;
    }

    .banner-socials {
        display: flex;
        gap: 20px;
        margin-bottom: 30px;
    }

    .social-icon {
        width: 42px;
        height: 42px;
        border-radius: 50%;
        background: rgba(255,255,255,0.1);
        backdrop-filter: blur(5px);
        border: 1px solid var(--glass-border);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.0rem;
        font-weight: 700;
        color: #fff;
        text-decoration: none;
        transition: background 0.2s ease, transform 0.2s ease;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    .social-icon:hover {
        background: var(--brand4);
        transform: translateY(-3px) scale(1.05);
        box-shadow: 0 5px 15px rgba(120,115,245,0.4);
    }

    .banner-actions {
        display: flex;
        gap: 15px;
        margin-top: 25px;
        flex-wrap: wrap;
    }
    
    /* Buttons in banner actions */
    .banner-actions .btn-primary {
        background: linear-gradient(90deg, var(--brand1), var(--brand4));
        box-shadow: 0 8px 20px rgba(174,103,250,.3);
    }
    .banner-actions .btn-primary:hover {
        background: linear-gradient(90deg, var(--brand4), var(--brand1));
    }
    .banner-actions .btn-glass {
        color: var(--brand5);
        border-color: var(--brand5);
        background: rgba(52, 176, 245, 0.1);
        box-shadow: 0 5px 15px rgba(52, 176, 245, 0.2);
    }
    .banner-actions .btn-glass:hover {
        background: rgba(52, 176, 245, 0.2);
        color: white;
    }


    /* Responsive adjustments for banner */
    @media (max-width: 992px) {
        .welcome-card {
            height: auto;
            max-width: 100%;
        }
        .banner-vip-overlay {
            flex-direction: column-reverse;
            text-align: center;
            padding: 30px;
            height: 100%;
        }
        .banner-content-left {
            text-align: center;
            min-width: unset;
            width: 100%;
            padding-right: 0;
            margin-bottom: 20px;
        }
        .banner-illustration-right {
            min-width: unset;
            width: 100%;
            max-width: 300px;
            margin-bottom: 25px;
        }
        .banner-tag, .banner-skills, .banner-socials, .banner-actions {
            justify-content: center;
            width: 100%;
        }
        .banner-description {
            margin-left: auto;
            margin-right: auto;
        }
        .banner-main-title {
            font-size: 2.5rem;
        }
        .banner-subtitle {
            font-size: 1.4rem;
        }
    }
    @media (max-width: 576px) {
        .banner-main-title {
            font-size: 2rem;
        }
        .banner-subtitle {
            font-size: 1.2rem;
        }
        .banner-vip-container {
            padding-bottom: 0;
            height: auto;
        }
        .banner-vip-overlay {
            padding: 20px;
        }
    }

    /* Balance display in Store */
    .balance-in-store-card {
        background: linear-gradient(135deg, var(--brand4), var(--brand1));
        padding: 20px 25px;
        border-radius: 18px;
        margin-bottom: 25px;
        color: #fff;
        box-shadow: 0 10px 30px rgba(0,0,0,0.25);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 15px;
        animation: slideInFromTop .5s ease-out;
    }
    .balance-in-store-card .title {
        font-size: 1.1rem;
        opacity: 0.8;
    }
    .balance-in-store-card .value {
        font-size: 2.2rem;
        font-weight: 900;
        letter-spacing: 1px;
    }
    .balance-in-store-card .btn-topup-store {
        background: rgba(255,255,255,0.2);
        backdrop-filter: blur(5px);
        border: 1px solid rgba(255,255,255,0.3);
        color: white;
        padding: 10px 18px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 700;
        transition: background .3s ease;
    }
    .balance-in-store-card .btn-topup-store:hover {
        background: rgba(255,255,255,0.3);
    }
    @keyframes slideInFromTop {
        from { opacity: 0; transform: translateY(-20px); }
        to { opacity: 1; transform: translateY(0); }
    }


    /* Store */
    .store-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));
    gap:24px;
    margin-top:0px;
    }
    .tool-card{padding:20px;border-radius:20px;
    background: linear-gradient(145deg, rgba(255,255,255,0.04), rgba(255,255,255,0.01));
    box-shadow: 0 6px 20px rgba(0,0,0,.2);
    backdrop-filter: blur(8px);
    border:1px solid var(--glass-border);
    display:flex;flex-direction:column;gap:10px;transition:transform .2s ease, box-shadow .2s, background .2s;
    }
    html[data-theme='light'] .tool-card{background: linear-gradient(145deg, rgba(0,0,0,0.02), rgba(0,0,0,0.005));}
    .tool-card:hover{transform:translateY(-6px);box-shadow:0 16px 35px rgba(0,0,0,.35);}
    .tool-card h4{margin:0;font-size:1.2rem;color:var(--brand5)}
    .tool-actions{margin-top:auto;display:flex;gap:12px} /* Added flex and gap for buttons */
    .tool-actions .btn { flex-grow: 1; text-align: center; } /* Make buttons fill space */
    .price{font-weight:900;font-size:1.2rem;color:var(--brand3)}

    /* Right sidebar */
    .sidebar{position:sticky;top:90px;padding:22px;border-radius:20px;
    background:var(--panel-dark);box-shadow:0 8px 30px rgba(0,0,0,.3);
    backdrop-filter: blur(10px);
    border:1px solid var(--glass-border);
    height:fit-content;transition:transform .3s ease-in-out, background .3s ease;
    }
    html[data-theme='light'] .sidebar{background:var(--panel-light);box-shadow:0 8px 30px rgba(0,0,0,.1);}

    /* Lists */
    .mytools-list{display:flex;flex-direction:column;gap:14px;margin-top:18px}
    .mytool{padding:14px;border-radius:16px;
    background:rgba(255,255,255,.03);display:flex;justify-content:space-between;align-items:center;transition:transform .2s, background .2s;
    border:1px solid rgba(255,255,255,.05);
    }
    .mytool:hover{transform:translateX(8px);background:rgba(255,255,255,.05);}

    /* Modal */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:linear-gradient(180deg,rgba(0,0,0,.6),rgba(0,0,0,.8));
    backdrop-filter:blur(8px);z-index:120}
    .modal.active{display:flex}
    .modal-card{width:100%;max-width:600px;
    padding:30px;border-radius:20px;
    background:var(--panel-dark);box-shadow:0 40px 100px rgba(0,0,0,.8);
    animation:fadeIn .4s ease-out;
    backdrop-filter: blur(15px);
    border:1px solid var(--glass-border);
    }
    html[data-theme='light'] .modal-card{background:var(--panel-light);box-shadow:0 40px 100px rgba(0,0,0,.3);}
    @keyframes fadeIn{from{opacity:0;transform:scale(.9)}to{opacity:1;transform:scale(1)}}

    .field{display:flex;flex-direction:column;gap:10px;margin-top:16px}
    .field label{font-weight:600;font-size:1.05rem;}
    .field input, .field select, .field textarea{padding:14px;border-radius:14px;
    border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.03);color:inherit;transition:border-color .2s, background .2s;
    }
    .field input:focus, .field textarea:focus{outline:none;border-color:var(--brand4);background:rgba(255,255,255,.05);}
    html[data-theme='light'] .field input, html[data-theme='light'] .field textarea{background:#f0f0f5;border-color:#e0e0e5;}

    /* Table */
    table{width:100%;border-collapse:collapse;margin-top:16px;font-size:0.95rem;}
    th,td{padding:14px;border-bottom:1px solid var(--glass-border);text-align:left;}
    th{background:rgba(255,255,255,.05);font-weight:700;}
    tbody tr:hover{background:rgba(255,255,255,.05);}

    /* Tabs */
    .tabs{display:flex;gap:12px;margin:16px 0;flex-wrap:wrap}
    .tabs .tab{padding:12px 20px;border-radius:14px;
    background:var(--glass);cursor:pointer;font-weight:700;transition:background .2s, color .2s;
    }
    .tabs .tab:hover{background:var(--glass-2); color: var(--brand3);}
    .tabs .tab.active{background:linear-gradient(90deg,var(--brand1),var(--brand4));color:#fff;box-shadow:0 3px 10px rgba(120,80,200,.2);}

    /* Toast */
    #dk_toast{position:fixed;right:20px;bottom:20px;z-index:9999}
    #dk_toast div{font-weight:700;border-radius:12px;}

    /* Helpers */
    .muted{color:var(--muted-dark)}
    .hidden{display:none}
    .copy{cursor:pointer;text-decoration:underline;font-weight:600;opacity:.8;transition:opacity .2s;color:var(--brand5)}
    .copy:hover{opacity:1;color:var(--brand3);}

    /* Map */
    .map-container{height:350px;
    width:100%;border-radius:16px;overflow:hidden;background:#333;position:relative;
    box-shadow: 0 8px 25px rgba(0,0,0,0.3);
    }
    .map-loader{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;color:#fff;background:rgba(0,0,0,0.85);z-index:10;}
    .map-loader::after {
        content: '';
        border: 4px solid rgba(255,255,255,0.3);
        border-top: 4px solid var(--brand4);
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin-top: 10px;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    /* Pulse animation for visit count */
    @keyframes pulse {
        0% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.05); opacity: 0.8; }
        100% { transform: scale(1); opacity: 1; }
    }
    .pulse-animation {
        animation: pulse 0.6s ease-out;
    }
  </style>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nqc+ByxW+zow+xLdD6A/uTJSJm7t9VbB3K91I+C08=" crossorigin=""></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4z7F/k2x2xI8+aWpT4u2+yC1G/8VzWq4i1r4oF9A=" crossorigin="" />
</head>
<body>
  <div class="overlay" id="mobileOverlay" aria-hidden="true"></div>
  <header class="navbar">
    <div class="nav-inner">
      <button type="button" class="mobile-menu-btn" id="btnOpenMobileMenu" aria-label="M·ªü menu ƒëi·ªÅu h∆∞·ªõng">‚ò∞</button>
      <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <div class="brand-text">Th√†nh Aov</div>
      </div>
      <nav class="header-nav-links" role="navigation">
          <a href="#welcomeSection" class="menu-item active" data-view="home">Home</a>
          <a href="#storeView" class="menu-item" data-view="store">Store</a>
          <a href="#profileView" class="menu-item" data-view="profile">Profile</a>
          <a href="#statsView" class="menu-item" data-view="stats">Stats</a>
          <a href="#contactView" class="menu-item" data-view="contact">Contact</a>
      </nav>
      <div class="cta">
        <label title="Theme" class="btn-glass" style="display:flex;align-items:center;gap:8px;border-radius:12px;padding:8px 12px;cursor:pointer">
          <input type="checkbox" id="themeToggle" style="display:none" aria-label="Chuy·ªÉn ƒë·ªïi ch·ªß ƒë·ªÅ s√°ng/t·ªëi" /> üåó
        </label>
        <button type="button" class="btn btn-glass" id="btnOpenAuth" aria-label="ƒêƒÉng nh·∫≠p ho·∫∑c ƒêƒÉng k√Ω">ƒêƒÉng nh·∫≠p / ƒêƒÉng k√Ω</button>
        <button type="button" class="btn btn-primary" id="btnOpenAdmin" aria-label="ƒêƒÉng nh·∫≠p v·ªõi quy·ªÅn Admin">Admin</button>
        <button type="button" class="btn btn-primary hidden" id="btnLogout" aria-label="ƒêƒÉng xu·∫•t">ƒêƒÉng xu·∫•t</button>
      </div>
    </div>
  </header>

  <div class="site-wrap">
    <!-- LEFT MENU (on PC) / MOBILE MENU (on phone) -->
    <aside class="side-menu" id="sideMenu" role="navigation">
      <div class="brand-in-menu">
          <div class="logo" aria-hidden="true"></div>
          <div>DangKhoa_Dev</div>
      </div>
      <!-- New: Mobile auth/admin buttons inside side menu -->
      <div class="side-menu-auth-actions" id="sideMenuAuthActions">
            <button type="button" class="btn btn-glass" id="sideMenuBtnOpenAuth" aria-label="ƒêƒÉng nh·∫≠p ho·∫∑c ƒêƒÉng k√Ω">ƒêƒÉng nh·∫≠p / ƒêƒÉng k√Ω</button>
            <button type="button" class="btn btn-primary" id="sideMenuBtnOpenAdmin" aria-label="ƒêƒÉng nh·∫≠p v·ªõi quy·ªÅn Admin">Admin</button>
            <button type="button" class="btn btn-primary btn-logout hidden" id="sideMenuBtnLogout" aria-label="ƒêƒÉng xu·∫•t">ƒêƒÉng xu·∫•t</button>
      </div>
      <!-- Current User / Admin Info in Mobile Menu -->
      <div class="small-muted" style="margin:0 22px; margin-top: 15px;">Phi√™n hi·ªán t·∫°i</div>
      <div id="sidebarUser" style="margin:8px 22px 10px;font-weight:800">Ch∆∞a ƒëƒÉng nh·∫≠p</div>
      <div id="adminBadge" class="small-muted hidden" style="margin:6px 22px">B·∫°n ƒëang ·ªü ch·∫ø ƒë·ªô Admin</div>

      <a class="menu-item active" data-view="home" aria-label="Trang ch·ªß">üè† Trang ch·ªß</a>
      <a class="menu-item" data-view="store" aria-label="Tool Store">üõí Tool Store</a>
      <a class="menu-item" data-view="mytools" aria-label="My Tools">üì¶ My Tools</a>
      <a class="menu-item" data-view="profile" aria-label="H·ªì s∆°">üë§ H·ªì s∆°</a>
      <a class="menu-item" data-view="tx" aria-label="L·ªãch s·ª≠ giao d·ªãch">üßæ L·ªãch s·ª≠ giao d·ªãch</a>
      <a class="menu-item" data-view="topup" aria-label="N·∫°p ti·ªÅn">üí∞ N·∫°p ti·ªÅn</a>
      <a class="menu-item" data-view="stats" aria-label="Th·ªëng k√™">üìà Th·ªëng k√™</a>
      <a class="menu-item" data-view="contact" aria-label="Li√™n h·ªá">‚úâ Li√™n h·ªá</a>
      <div style="height:12px"></div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="main" role="main">
      <!-- Welcome -->
      <section id="welcomeSection" aria-labelledby="welcomeTitle">
        <div class="welcome-card">
          <div class="banner-vip-container">
            <!-- Canvas for dynamic particle background -->
            <canvas id="bannerCanvas"></canvas>
            <div class="banner-vip-overlay">
                <div class="banner-content-left">
                    <div class="banner-tag">‚ö° Ready to innovate</div>
                    <h3 class="banner-main-title">Shop Th·∫ßy Th√†nh</h3>
                    <p class="banner-subtitle">T√†i Li·ªáu Map Li√™n Qu√¢n</p>
                    <p class="banner-description">Menciptakan Website Yang Inovatif, Fungsional, dan User-Friendly untuk Solusi Digital.</p>
                    <div class="banner-skills">
                        <span class="skill-tag">React</span>
                        <span class="skill-tag">Javascript</span>
                        <span class="skill-tag">Node.js</span>
                        <span class="skill-tag">Tailwind</span>
                    </div>
                    <div class="banner-socials">
                        <a href="#" class="social-icon">IN</a>
                        <a href="#" class="social-icon">LI</a>
                        <a href="#" class="social-icon">IG</a>
                    </div>
                    <div class="banner-actions">
                        <button type="button" class="btn btn-primary" id="bannerProjectsBtn">Projects ‚Üó</button>
                        <button type="button" class="btn btn-glass" id="bannerContactBtn">Contact ‚úâ</button>
                    </div>
                </div>
                <div class="banner-illustration-right">
                    <img src="uploaded:image_8127c5.jpg-961618e3-59bd-4511-a653-cbe3eeb26ad9" alt="Frontend Developer Illustration" />
                </div>
            </div>
          </div>
        </div>
      </section>

      <!-- STORE VIEW -->
      <section id="storeView" class="hidden" aria-labelledby="storeTitle">
        <h2 id="storeTitle">Tool Store</h2>
        <div id="balanceInStore" class="balance-in-store-card">
            <div>
                <div class="title">S·ªë d∆∞ t√†i kho·∫£n</div>
                <div class="value" id="storeBalanceVal">0 ƒë</div>
            </div>
            <button type="button" class="btn-topup-store" id="btnTopupFromStore" aria-label="N·∫°p ti·ªÅn ngay">N·∫°p ti·ªÅn ngay</button>
        </div>
        <div class="store-grid" id="storeGrid"></div>
      </section>

      <!-- MY TOOLS -->
      <section id="mytoolsView" class="hidden" aria-labelledby="mytoolsTitle">
        <h2 id="mytoolsTitle">My Tools</h2>
        <div id="mytoolsList" class="mytools-list"></div>
      </section>

      <!-- PROFILE -->
      <section id="profileView" class="hidden" aria-labelledby="profileTitle">
        <h2 id="profileTitle">H·ªì s∆°</h2>
        <div id="profilePanel" class="profile-card" style="margin-top:16px"></div>
      </section>

      <!-- TRANSACTIONS (USER VIEW) -->
      <section id="txView" class="hidden" aria-labelledby="txTitle">
        <h2 id="txTitle">L·ªãch s·ª≠ giao d·ªãch</h2>
        <div id="userTxTableWrap" style="margin-top:12px;overflow:auto;max-height:420px"></div>
        <div id="userTopupRequestsList" style="margin-top:20px;">
            <h3>Y√™u c·∫ßu n·∫°p ti·ªÅn c·ªßa b·∫°n</h3>
            <div id="userTopupRequestsTableWrap">
                <div class="muted">B·∫°n kh√¥ng c√≥ y√™u c·∫ßu n·∫°p ti·ªÅn n√†o.</div>
            </div>
        </div>
      </section>

      <!-- STATS VIEW -->
      <section id="statsView" class="hidden" aria-labelledby="statsTitle">
        <h2 id="statsTitle">Th·ªëng k√™ l∆∞·ª£t truy c·∫≠p</h2>
        <div style="display: flex; gap: 24px; flex-wrap: wrap; align-items: flex-start;">
            <div style="flex: 1; min-width: 200px;">
                <div class="muted">T·ªïng l∆∞·ª£t truy c·∫≠p (phi√™n hi·ªán t·∫°i)</div>
                <div id="totalVisits" style="font-size: 2.5rem; font-weight: 800; color: var(--brand4)">0</div>
                <div class="muted" style="margin-top: 10px;">
                    *L∆∞u √Ω: S·ªë li·ªáu th·ªëng k√™ ch·ªâ t√≠nh khi ng∆∞·ªùi d√πng v√†o Website .<br>
                </div>
            </div>
            <div style="flex: 2; min-width: 300px;" class="map-container">
                <div id="visitorMap" style="width: 100%; height: 100%;" role="img" aria-label="B·∫£n ƒë·ªì c√°c l∆∞·ª£t truy c·∫≠p demo"></div>
                <div id="mapLoader" class="map-loader">ƒêang t·∫£i b·∫£n ƒë·ªì...</div>
            </div>
        </div>
      </section>

      <!-- CONTACT FORM -->
      <section id="contactView" class="hidden" aria-labelledby="contactTitle">
        <h2 id="contactTitle">Li√™n h·ªá</h2>
        <div style="background:var(--panel-dark); padding:24px; border-radius:20px; margin-top:16px; border:1px solid var(--glass-border); box-shadow:0 4px 15px rgba(0,0,0,.2);">
            <p class="muted" style="margin-bottom:20px;">B·∫°n c√≥ c√¢u h·ªèi ho·∫∑c mu·ªën g·ª≠i tin nh·∫Øn? Vui l√≤ng ƒëi·ªÅn v√†o form d∆∞·ªõi ƒë√¢y. Ch√∫ng t√¥i s·∫Ω c·ªë g·∫Øng ph·∫£n h·ªìi s·ªõm nh·∫•t c√≥ th·ªÉ.</p>
            <div class="field">
                <label for="contactName">T√™n c·ªßa b·∫°n</label>
                <input id="contactName" type="text" placeholder="T√™n c·ªßa b·∫°n" aria-required="true" />
            </div>
            <div class="field">
                <label for="contactEmail">Email c·ªßa b·∫°n</label>
                <input id="contactEmail" type="email" placeholder="email@example.com" aria-required="true" />
            </div>
            <div class="field">
                <label for="contactSubject">Ti√™u ƒë·ªÅ</label>
                <input id="contactSubject" type="text" placeholder="Ti√™u ƒë·ªÅ tin nh·∫Øn" aria-required="true" />
            </div>
            <div class="field">
                <label for="contactMessage">N·ªôi dung</label>
                <textarea id="contactMessage" rows="5" placeholder="N·ªôi dung tin nh·∫Øn c·ªßa b·∫°n" aria-required="true"></textarea>
            </div>
            <div style="margin-top:20px;">
                <button type="button" class="btn btn-primary" id="sendContactEmail" aria-label="G·ª≠i tin nh·∫Øn">G·ª≠i tin nh·∫Øn</button>
                <p class="muted" style="margin-top:12px;">*Tin nh·∫Øn s·∫Ω ƒë∆∞·ª£c g·ª≠i qua ·ª©ng d·ª•ng email m·∫∑c ƒë·ªãnh c·ªßa b·∫°n t·ªõi <strong style="color:var(--brand5)">nkhoa3906@gmail.com</strong>.</p>
            </div>
        </div>
      </section>

      <!-- ADMIN PANEL -->
      <section id="adminPanel" class="hidden" aria-labelledby="adminPanelTitle">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h2 id="adminPanelTitle">Admin Panel</h2>
          <div class="small-muted">Admin: <span id="adminName">admin</span></div>
        </div>
        <div class="tabs" role="tablist">
          <button type="button" class="tab active" id="tabAdminTopupRequests" role="tab" aria-selected="true" aria-controls="adminTopupRequestsContent">Y√™u c·∫ßu n·∫°p ti·ªÅn</button> <!-- NEW TAB FOR ADMIN -->
          <button type="button" class="tab" id="tabPend" role="tab" aria-selected="false" aria-controls="adminPendContent">ƒê∆°n ch·ªù duy·ªát</button>
          <button type="button" class="tab" id="tabHist" role="tab" aria-selected="false" aria-controls="adminHistContent">L·ªãch s·ª≠ giao d·ªãch</button>
          <button type="button" class="tab" id="tabUsers" role="tab" aria-selected="false" aria-controls="adminUsersContent">Qu·∫£n l√Ω ng∆∞·ªùi d√πng</button>
          <button type="button" class="tab" id="tabStats" role="tab" aria-selected="false" aria-controls="adminStatsContent">Th·ªëng k√™</button>
        </div>
        
        <!-- ADMIN TOPUP REQUESTS CONTENT -->
        <div id="adminTopupRequestsContent" role="tabpanel">
            <h3>Y√™u c·∫ßu n·∫°p ti·ªÅn ƒëang ch·ªù duy·ªát</h3>
            <div id="topupRequestsTableWrap">
                <div class="muted">Kh√¥ng c√≥ y√™u c·∫ßu n·∫°p ti·ªÅn n√†o ƒëang ch·ªù.</div>
            </div>
        </div>

        <div id="adminPendContent" class="hidden" role="tabpanel">
            <div class="muted">Ch·ª©c nƒÉng qu·∫£n l√Ω ƒë∆°n h√†ng ƒëang ho·∫°t ƒë·ªông.</div>
        </div>
        <div id="adminHistContent" class="hidden" role="tabpanel">
          <div style="display:flex;gap:8px;flex-wrap:wrap;margin:8px 0">
            <label for="fUser" class="sr-only">L·ªçc theo user</label>
            <input id="fUser" placeholder="L·ªçc theo user (email ho·∫∑c t√™n)" aria-label="L·ªçc theo user" />
            <label for="fFrom" class="sr-only">T·ª´ ng√†y</label>
            <input id="fFrom" type="date" aria-label="T·ª´ ng√†y" />
            <label for="fTo" class="sr-only">ƒê·∫øn ng√†y</label>
            <input id="fTo" type="date" aria-label="ƒê·∫øn ng√†y" />
            <button type="button" class="btn btn-glass" id="btnFilter" aria-label="L·ªçc">L·ªçc</button>
            <button type="button" class="btn btn-glass" id="btnResetFilter" aria-label="X√≥a b·ªô l·ªçc">X√≥a l·ªçc</button>
          </div>
          <div id="adminHistTable" style="max-height:420px;overflow:auto" role="table" aria-label="L·ªãch s·ª≠ giao d·ªãch Admin">
              <div class="muted">L·ªãch s·ª≠ giao d·ªãch ƒëang ho·∫°t ƒë·ªông.</div>
          </div>
        </div>
        <div id="adminUsersContent" class="hidden" role="tabpanel">
            <h3>Danh s√°ch ng∆∞·ªùi d√πng</h3>
            <div id="adminUsersTableWrap" style="max-height:420px;overflow-y:auto;margin-top:12px;">
                <div class="muted">ƒêang t·∫£i danh s√°ch ng∆∞·ªùi d√πng...</div>
            </div>
        </div>
        <div id="adminStatsContent" class="hidden" role="tabpanel">
            <div class="field">
                <label for="manualVisits">TƒÉng l∆∞·ª£t truy c·∫≠p</label>
                <input id="manualVisits" type="number" placeholder="Nh·∫≠p s·ªë l∆∞·ª£ng mu·ªën tƒÉng" min="1" value="100" aria-label="S·ªë l∆∞·ª£t truy c·∫≠p mu·ªën tƒÉng" />
            </div>
            <div style="margin-top: 12px;">
                <button type="button" class="btn btn-primary" id="btnIncreaseVisits" aria-label="TƒÉng l∆∞·ª£t truy c·∫≠p">TƒÉng</button>
            </div>
             <div class="muted" style="margin-top: 10px;">
                *L∆∞u √Ω: Ch·ª©c nƒÉng n√†y ch·ªâ thay ƒë·ªïi s·ªë l∆∞·ª£t truy c·∫≠p tr√™n giao di·ªán tr√¨nh duy·ªát hi·ªán t·∫°i, kh√¥ng ·∫£nh h∆∞·ªüng ƒë·∫øn d·ªØ li·ªáu th·ª±c.
            </div>
        </div>
      </section>
    </main>

    <!-- RIGHT SIDEBAR -->
    <aside class="sidebar" role="complementary">
      <div style="display:flex;gap:16px;align-items:center">
        <div style="width:72px;height:72px;border-radius:16px;background:var(--glass);display:flex;align-items:center;justify-content:center;font-size:2rem" id="sideAvatar" aria-hidden="true">üë§</div>
        <div>
          <div id="sideName" style="font-weight:800;font-size:1.25rem">Kh√°ch</div>
          <div class="small-muted" id="sideEmail">Ch∆∞a ƒëƒÉng nh·∫≠p</div>
        </div>
      </div>

      <div class="row" style="margin-top:20px">
        <div class="small-muted">S·ªë d∆∞ hi·ªán t·∫°i</div>
        <div class="balance" id="balanceVal" style="margin-top:4px">0 ƒë</div>
        <div style="margin-top:12px"><button type="button" class="btn btn-primary" id="openTopup" aria-label="N·∫°p ti·ªÅn">N·∫°p ti·ªÅn</button></div>
      </div>

      <div class="row" style="margin-top:20px">
        <div class="small-muted">ƒê√£ mua</div>
        <div id="purchasedCount">0</div>
      </div>

      <div class="row" style="margin-top:20px">
        <div class="small-muted">Ng√†y ƒëƒÉng k√Ω</div>
        <div id="regDate">-</div>
      </div>

      <div class="row">
        <div style="margin-top:16px"><button type="button" class="btn btn-glass" id="viewTransactions" aria-label="Xem l·ªãch s·ª≠ giao d·ªãch">L·ªãch s·ª≠ giao d·ªãch</button></div>
      </div>

      <div class="row">
        <div class="small-muted" style="margin-top:20px">My Tools</div>
        <div id="miniMyTools" style="margin-top:12px"></div>
      </div>
    </aside>
  </div>

  <!-- AUTH MODAL (login/register) -->
  <div class="modal" id="authModal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="authModalTitle">
    <div class="modal-card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><h2 id="authModalTitle">ƒêƒÉng nh·∫≠p / ƒêƒÉng k√Ω</h2><button type="button" id="closeAuth" class="btn-glass" aria-label="ƒê√≥ng">‚úï</button></div>
      <div class="tabs" role="tablist"><button type="button" class="tab active" id="tabLogin" role="tab" aria-selected="true" aria-controls="loginFormContent">ƒêƒÉng nh·∫≠p</button><button type="button" class="tab" id="tabRegister" role="tab" aria-selected="false" aria-controls="registerFormContent">ƒêƒÉng k√Ω</button></div>

      <div id="loginFormContent" role="tabpanel">
        <div class="field"><label for="li_user">Email / Username</label><input id="li_user" placeholder="t√™n ho·∫∑c email" aria-required="true"/></div>
        <div class="field"><label for="li_pass">M·∫≠t kh·∫©u</label><input id="li_pass" type="password" aria-required="true"/></div>
        <div style="display:flex;gap:12px;align-items:center;margin-top:16px">
          <button type="button" class="btn btn-primary" id="doLogin" aria-label="Th·ª±c hi·ªán ƒëƒÉng nh·∫≠p">ƒêƒÉng nh·∫≠p</button>
          <label style="display:flex;align-items:center;gap:8px;margin-left:8px"><input type='checkbox' id='li_remember' /> Nh·ªõ t√¥i</label>
          <div style="margin-left:auto" class="muted">Ho·∫∑c <a href="#" id="goRegister" aria-label="Chuy·ªÉn ƒë·∫øn trang ƒëƒÉng k√Ω">t·∫°o t√†i kho·∫£n</a></div>
        </div>
        <div id="loginErr" class="muted" style="color:var(--brand4);display:none;margin-top:12px" aria-live="polite"></div>
        <div class="muted" style="margin-top:12px;">*L∆∞u √Ω: Ch·ª©c nƒÉng n√†y ƒëang ho·∫°t ƒë·ªông th·ª±c t·∫ø.</div>
      </div>

      <div id="registerFormContent" class="hidden" role="tabpanel">
        <div class="field"><label for="rg_name">H·ªç t√™n</label><input id="rg_name" placeholder="Nguy·ªÖn VƒÉn A" aria-required="true"/></div>
        <div class="field"><label for="rg_email">Email</label><input id="rg_email" type="email" placeholder="dangkhoamxh678@gmail.com" aria-required="true"/></div>
        <div class="field"><label for="rg_pass">M·∫≠t kh·∫©u</label><input id="rg_pass" type="password" placeholder="6+ k√Ω t·ª±" aria-required="true"/></div>
        <div class="field"><label for="rg_pass2">X√°c nh·∫≠n m·∫≠t kh·∫©u</label><input id="rg_pass2" type="password" aria-required="true"/></div>
        <div style="display:flex;gap:12px;align-items:center;margin-top:16px"><button type="button" class="btn btn-primary" id="doRegister" aria-label="T·∫°o t√†i kho·∫£n">T·∫°o t√†i kho·∫£n</button><div class="muted">S·ªë d∆∞ m·∫∑c ƒë·ªãnh 100.000ƒë.</div></div>
        <div id="regErr" class="muted" style="color:var(--brand4);display:none;margin-top:12px" aria-live="polite"></div>
        <div class="muted" style="margin-top:12px;">*L∆∞u √Ω: Ch·ª©c nƒÉng n√†y ƒëang ho·∫°t ƒë·ªông th·ª±c t·∫ø.</div>
      </div>
    </div>
  </div>

  <!-- ADMIN LOGIN MODAL -->
  <div class="modal" id="adminLoginModal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="adminLoginModalTitle">
    <div class="modal-card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><h2 id="adminLoginModalTitle">ƒêƒÉng nh·∫≠p Admin</h2><button type="button" id="closeAdminLogin" class="btn-glass" aria-label="ƒê√≥ng">‚úï</button></div>
      <div class="field"><label for="ad_user">T√†i kho·∫£n Admin</label><input id="ad_user" placeholder="admin" value="admin" aria-required="true"/></div>
      <div class="field"><label for="ad_pass">M·∫≠t kh·∫©u</label><input id="ad_pass" type="password" placeholder="admin123" aria-required="true"/></div>
      <div style="display:flex;gap:12px;align-items:center;margin-top:16px"><button type="button" class="btn btn-primary" id="doAdminLogin" aria-label="ƒêƒÉng nh·∫≠p Admin">ƒêƒÉng nh·∫≠p</button><div class="muted">M·∫∑c ƒë·ªãnh: <code>Kh√¥ng C√≥</code></div></div>
      <div id="adErr" class="muted" style="color:var(--brand4);display:none;margin-top:12px" aria-live="polite"></div>
      <div class="muted" style="margin-top:12px;">*L∆∞u √Ω: Ch·ª©c nƒÉng n√†y ƒëang ho·∫°t ƒë·ªông th·ª±c t·∫ø.</div>
    </div>
  </div>

  <!-- TOPUP MODAL (USER) -->
  <div class="modal" id="topupModal" role="dialog" aria-modal="true" aria-labelledby="topupModalTitle">
    <div class="modal-card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><h2 id="topupModalTitle">N·∫°p ti·ªÅn qua BIDV</h2><button type="button" id="closeTopup" class="btn-glass" aria-label="ƒê√≥ng">‚úï</button></div>
      <div class="field"><label for="tp_amount">S·ªë ti·ªÅn (VNƒê)</label><input id="tp_amount" type="number" min="1000" placeholder="VD: 100000" aria-required="true"/></div>
      <div class="field"><label for="tp_content">N·ªôi dung chuy·ªÉn kho·∫£n</label><input id="tp_content" placeholder="nap_tien_[username]" aria-required="true"/></div>
      <div class="field"><label>Th√¥ng tin th·ª• h∆∞·ªüng</label>
        <div style="display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center">
          <div>Ng√¢n h√†ng: <strong>BIDV</strong></div><div></div>
          <div>S·ªë TK: <strong id="bankAcc">8836023812</strong></div><button type="button" class="btn btn-glass" data-copy="#bankAcc" aria-label="Sao ch√©p s·ªë t√†i kho·∫£n">Copy</button>
          <div>Ch·ªß TK: <strong id="bankName">Nguyen Dang Khoa _or_ Nguyen Minh Tri</strong></div><button type="button" class="btn btn-glass" data-copy="#bankName" aria-label="Sao ch√©p t√™n ch·ªß t√†i kho·∫£n">Copy</button>
          <div>N·ªôi dung: <strong id="bankMemo">nap_tien_dangkhoa99</strong></div><button type="button" class="btn btn-glass" data-copy="#bankMemo" aria-label="Sao ch√©p n·ªôi dung chuy·ªÉn kho·∫£n">Copy</button>
        </div>
      </div>
      <div class="field"><label>QR Code</label>
        <div id="qrWrap" style="display:flex;gap:16px;align-items:center;flex-wrap:wrap">
          <img id="qrImg" width="180" height="180" style="border-radius:12px;background:#fff" alt="QR Code ng√¢n h√†ng" />
          <div class="muted">Qu√©t QR ƒë·ªÉ chuy·ªÉn kho·∫£n. Sau ƒë√≥ nh·∫•n <strong>X√°c nh·∫≠n ƒë√£ chuy·ªÉn</strong>.</div>
        </div>
      </div>
      <div style="display:flex;gap:12px;margin-top:16px">
        <button type="button" class="btn btn-primary" id="doTopupRequest" aria-label="X√°c nh·∫≠n ƒë√£ chuy·ªÉn kho·∫£n">X√°c nh·∫≠n ƒë√£ chuy·ªÉn</button>
        <button type="button" class="btn btn-glass" id="quickContact" aria-label="Li√™n h·ªá nhanh h·ªó tr·ª£">Li√™n h·ªá nhanh</button>
      </div>
      <div class="muted" style="margin-top:12px">*L∆∞u √Ω: Vui L√≤ng ƒê·ª£i Admin Ki·ªÉm Duy·ªát Sau Khi N·∫°p| Q√∫a Tr√¨nh Ki·ªÉm Duy·ªát S·∫Ω Di·ªÖn Ra Nhanh Ch√≥ng</div>
    </div>
  </div>

  <!-- TRANSACTIONS MODAL (quick list) -->
  <div class="modal" id="txModal" role="dialog" aria-modal="true" aria-labelledby="txModalTitle">
    <div class="modal-card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><h2 id="txModalTitle">L·ªãch s·ª≠ giao d·ªãch</h2><button type="button" id="closeTx" class="btn-glass" aria-label="ƒê√≥ng">‚úï</button></div>
      <div id="txList" style="max-height:320px;overflow:auto">
          <div class="muted">L·ªãch s·ª≠ giao d·ªãch ƒëang ho·∫°t ƒë·ªông.</div>
      </div>
    </div>
  </div>

  <!-- PROFILE EDIT MODAL -->
  <div class="modal" id="profileModal" role="dialog" aria-modal="true" aria-labelledby="profileEditModalTitle">
    <div class="modal-card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><h2 id="profileEditModalTitle">Ch·ªânh s·ª≠a h·ªì s∆°</h2><button type="button" id="closeProfile" class="btn-glass" aria-label="ƒê√≥ng">‚úï</button></div>
      <div class="field"><label for="pf_name">H·ªç t√™n</label><input id="pf_name" value="Kh√°ch" aria-required="true"/></div>
      <div class="field"><label for="pf_email">Email</label><input id="pf_email" value="khach@demo.com" aria-required="true"/></div>
      <div style="margin-top:16px"><button type="button" class="btn btn-primary" id="saveProfile" aria-label="L∆∞u h·ªì s∆°">L∆∞u</button></div>
      <div class="muted" style="margin-top:12px;">*L∆∞u √Ω: Ch·ª©c nƒÉng n√†y ƒëang ho·∫°t ƒë·ªông th·ª±c t·∫ø.</div>
    </div>
  </div>

  <!-- TOOL DETAIL MODAL (NEW) -->
  <div class="modal" id="toolDetailModal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="toolDetailModalTitle">
    <div class="modal-card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <h2 id="toolDetailModalTitle">Chi ti·∫øt Tool</h2>
            <button type="button" id="closeToolDetail" class="btn-glass" aria-label="ƒê√≥ng">‚úï</button>
        </div>
        <div id="toolDetailContent">
            <h3 id="td_name" style="margin-top:0;font-size:1.8rem;color:var(--brand5)"></h3>
            <p id="td_fullDesc" class="muted" style="line-height: 1.6;"></p>
            <div style="margin-top:15px;font-size:1.3rem;font-weight:700;">Gi√°: <span id="td_price" style="color:var(--brand3)"></span></div>
            <div id="td_actions" style="margin-top:20px;display:flex;gap:12px;flex-wrap:wrap">
                <button type="button" class="btn btn-primary" id="td_buyBtn">Mua ngay</button>
                <a href="#" target="_blank" class="btn btn-glass hidden" id="td_viewMoreLink">Xem th√™m ‚Üó</a>
            </div>
            <div class="muted" style="margin-top:15px;">*L∆∞u √Ω: C√°c ch·ª©c nƒÉng mua v√† t·∫£i ch·ªâ l√† Th·ª±c T·∫ø.</div>
        </div>
    </div>
  </div>

  <!-- ADMIN EDIT USER MODAL (NEW) -->
<div class="modal" id="adminEditUserModal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="adminEditUserModalTitle">
    <div class="modal-card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <h2 id="adminEditUserModalTitle">Ch·ªânh s·ª≠a th√¥ng tin ng∆∞·ªùi d√πng</h2>
            <button type="button" id="closeAdminEditUser" class="btn-glass" aria-label="ƒê√≥ng">‚úï</button>
        </div>
        <div id="adminEditUserContent">
            <input type="hidden" id="aeu_id" />
            <div class="field"><label for="aeu_name">H·ªç t√™n</label><input id="aeu_name" aria-required="true"/></div>
            <div class="field"><label for="aeu_email">Email</label><input id="aeu_email" type="email" aria-required="true"/></div>
            <div class="field"><label for="aeu_balance">S·ªë d∆∞ (VNƒê)</label><input id="aeu_balance" type="number" min="0" aria-required="true"/></div>
            <div style="margin-top:20px;display:flex;gap:12px">
                <button type="button" class="btn btn-primary" id="doAdminEditUser">L∆∞u thay ƒë·ªïi</button>
                <button type="button" class="btn btn-danger" id="doAdminDeleteUserFromEditModal">X√≥a ng∆∞·ªùi d√πng</button>
            </div>
            <div class="muted" style="margin-top:15px;">*L∆∞u √Ω: Kh√¥ng H·ªëi H·∫≠n Sau Khi Thay ƒê·ªïi.</div>
        </div>
    </div>
</div>


  <div id="dk_toast" aria-live="polite" aria-atomic="true"></div>

  <footer style="max-width:100%;
  margin:32px auto 40px; /* Reduced bottom margin */
  padding-inline:40px;
  display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px" role="contentinfo">
    <div>¬© <span id="fYear"></span> DangKhoa_Dev</div>
    <div style="display:flex;gap:16px"><a href="#" class="muted" aria-label="Facebook">Facebook</a><a href="#" class="muted" aria-label="YouTube">YouTube</a><a href="#" class="muted" aria-label="GitHub">GitHub</a></div>
  </footer>

  <script>
    /***********************
     * CONFIG & STATIC DATA (DEMO ONLY)
     ***********************/
    // C√ÅC ƒê∆Ø·ªúNG LINK TOOL CH·ªà ƒê·ªÇ DEMO, KH√îNG C√ì CH·ª®C NƒÇNG TH·ª∞C T·∫æ TRONG FILE HTML N√ÄY
    const TOOLS = [
      { id:'t1', name:'Tool Spam SMS', desc:'Mos Skin', price:150000, 
        detailLink:'https://example.com/sms-details', 
        downloadLink:'https://placehold.co/200x100/7873f5/fff?text=Download+SMS', 
        fullDesc: 'C√¥ng c·ª• gi√∫p b·∫°n g·ª≠i tin nh·∫Øn SMS h√†ng lo·∫°t m·ªôt c√°ch nhanh ch√≥ng v√† hi·ªáu qu·∫£ ƒë·ªÉ ti·∫øp c·∫≠n kh√°ch h√†ng ti·ªÅm nƒÉng. H·ªó tr·ª£ g·ª≠i tin nh·∫Øn t√πy ch·ªânh, l√™n l·ªãch v√† qu·∫£n l√Ω danh s√°ch ng∆∞·ªùi nh·∫≠n.' },
      { id:'t2', name:'Tool Spam Ngl', desc:'Hack Lq', price:150000, 
        detailLink:'https://example.com/ngl-details', 
        downloadLink:'https://placehold.co/200x100/ff6ec4/fff?text=Download+Ngl', 
        fullDesc: 'G·ª≠i tin nh·∫Øn ·∫©n danh tr√™n NGL m·ªôt c√°ch t·ª± ƒë·ªông. TƒÉng t∆∞∆°ng t√°c v√† t·∫°o s·ª± ch√∫ √Ω cho h·ªì s∆° c·ªßa b·∫°n. D·ªÖ d√†ng s·ª≠ d·ª•ng v√† t√πy ch·ªânh n·ªôi dung.' },
      { id:'t3', name:'Tool Spam Locket', desc:'Spam KB Locket', price:150000, 
        detailLink:'https://example.com/locket-details', 
        downloadLink:'https://placehold.co/200x100/4ade80/fff?text=Download+Locket', 
        fullDesc: 'T·ª± ƒë·ªông g·ª≠i c√°c tin nh·∫Øn ho·∫∑c ·∫£nh v√†o Locket c·ªßa b·∫°n b√®. Gi√∫p b·∫°n th·ªÉ hi·ªán s·ª± quan t√¢m v√† k·∫øt n·ªëi m·ªôt c√°ch ƒë·ªôc ƒë√°o.' },
      { id:'t4', name:'Tool Golike TikTok', desc:'C√†y MMO', price:250000, 
        detailLink:'https://example.com/tiktok-details', 
        downloadLink:'https://placehold.co/200x100/22d3ee/fff?text=Download+TikTok', 
        fullDesc: 'T·ª± ƒë·ªông th·ª±c hi·ªán c√°c nhi·ªám v·ª• tr√™n Golike ƒë·ªÉ ki·∫øm ti·ªÅn online th√¥ng qua n·ªÅn t·∫£ng TikTok. TƒÉng t∆∞∆°ng t√°c, like, follow v√† view m·ªôt c√°ch hi·ªáu qu·∫£.' },
      { id:'t5', name:'Bot Zalo T·ª± ƒê·ªông', desc:'BOT AUTO DOANH NGHIEP', price:1000000, 
        detailLink:'https://example.com/zalo-details', 
        downloadLink:'https://placehold.co/200x100/ff6ec4/fff?text=Download+Zalo', 
        fullDesc: 'Bot Zalo t·ª± ƒë·ªông h√≥a c√°c ho·∫°t ƒë·ªông kinh doanh tr√™n n·ªÅn t·∫£ng Zalo. G·ª≠i tin nh·∫Øn t·ª± ƒë·ªông, qu·∫£n l√Ω kh√°ch h√†ng, v√† t∆∞∆°ng t√°c hi·ªáu qu·∫£ ƒë·ªÉ tƒÉng doanh s·ªë.' }
    ];

    // D·ªØ li·ªáu ng∆∞·ªùi d√πng gi·∫£ ƒë·ªãnh cho UI demo (L∆ØU TRONG localStorage, KH√îNG AN TO√ÄN TR√äN TH·ª∞C T·∫æ)
    const LS_USERS_KEY = 'DK_DEMO_USERS_V1';
    const LS_CURRENT_USER_KEY = 'DK_DEMO_CURRENT_USER_V1';
    const LS_ADMIN_LOGIN_KEY = 'DK_DEMO_ADMIN_LOGIN_V1';
    const LS_VISITS_KEY = 'DK_DEMO_TOTAL_VISITS_V1';
    const LS_TOPUP_REQUESTS_KEY = 'DK_DEMO_TOPUP_REQUESTS_V1'; // New: Key for top-up requests

    let currentVisits = 0; // S·ªë l∆∞·ª£t truy c·∫≠p ch·ªâ t√≠nh trong phi√™n duy·ªát web hi·ªán t·∫°i (demo)


    // V·ªã tr√≠ gi·∫£ cho b·∫£n ƒë·ªì
    const demoVisitorLocations = [
        { lat: 21.0285, lon: 105.8542, city: 'H√† N·ªôi' },
        { lat: 10.7626, lon: 106.6601, city: 'TP. H·ªì Ch√≠ Minh' },
        { lat: 16.0544, lon: 108.2022, city: 'ƒê√† N·∫µng' },
        { lat: 10.0333, lon: 105.7833, city: 'C·∫ßn Th∆°' },
        { lat: 20.8449, lon: 106.6881, city: 'H·∫£i Ph√≤ng' },
    ];


    /***********************
     * HELPERS
     ***********************/
    const $=sel=>document.querySelector(sel);
    const $all=sel=>Array.from(document.querySelectorAll(sel));
    
    // Toast utility
    function showToast(message, type='info', duration=3500){
      const container = document.getElementById('dk_toast');
      const el = document.createElement('div');
      el.textContent = message;
      el.style.padding = '12px 18px'; el.style.marginTop='10px'; el.style.borderRadius='12px'; el.style.boxShadow='0 8px 24px rgba(2,6,23,.5)'; el.style.color='#fff'; el.style.fontWeight='700'; el.style.opacity='0'; el.style.transform='translateY(8px)'; el.style.transition='all .35s';
      if(type==='success') el.style.background='linear-gradient(90deg,var(--brand3),var(--brand4))';
      else if(type==='error') el.style.background='linear-gradient(90deg,#ef4444,#f97316)';
      else if(type==='warn') el.style.background='linear-gradient(90deg,var(--warn),#fbc531)';
      else el.style.background='linear-gradient(90deg,var(--brand1),var(--brand4))';
      container.appendChild(el);
      requestAnimationFrame(()=>{el.style.opacity='1'; el.style.transform='translateY(0)'});
      setTimeout(()=>{el.style.opacity='0'; el.style.transform='translateY(8px)'; setTimeout(()=>el.remove(),350)},duration);
    }
    function shake(el){ if(!el) return; el.animate([{transform:'translateX(0)'},{transform:'translateX(-8px)'},{transform:'translateX(8px)'},{transform:'translateX(0)'}],{duration:400}) }

    /***********************
     * AUTH & UI Management (DEMO ONLY)
     ***********************/
    function getDemoUsers() {
        return JSON.parse(localStorage.getItem(LS_USERS_KEY) || '[]');
    }

    function setDemoUsers(users) {
        localStorage.setItem(LS_USERS_KEY, JSON.stringify(users));
    }

    function getCurrentDemoUser() {
        return JSON.parse(localStorage.getItem(LS_CURRENT_USER_KEY) || 'null');
    }

    function setCurrentDemoUser(user) {
        localStorage.setItem(LS_CURRENT_USER_KEY, JSON.stringify(user));
    }

    function getAdminLoginStatus() {
        return localStorage.getItem(LS_ADMIN_LOGIN_KEY) === 'true';
    }

    function setAdminLoginStatus(status) {
        localStorage.setItem(LS_ADMIN_LOGIN_KEY, status ? 'true' : 'false');
    }

    function getTopupRequests() {
        return JSON.parse(localStorage.getItem(LS_TOPUP_REQUESTS_KEY) || '[]');
    }

    function setTopupRequests(requests) {
        localStorage.setItem(LS_TOPUP_REQUESTS_KEY, JSON.stringify(requests));
    }

    function updateAuthButtonsInSideMenu(isLoggedInUser, isLoggedInAdmin) {
        const sideMenuAuthActions = $('#sideMenuAuthActions');
        const sideMenuBtnOpenAuth = $('#sideMenuBtnOpenAuth');
        const sideMenuBtnOpenAdmin = $('#sideMenuBtnOpenAdmin');
        const sideMenuBtnLogout = $('#sideMenuBtnLogout');

        if (isLoggedInUser || isLoggedInAdmin) {
            sideMenuBtnOpenAuth.classList.add('hidden');
            sideMenuBtnOpenAdmin.classList.add('hidden');
            sideMenuBtnLogout.classList.remove('hidden');
        } else {
            sideMenuBtnOpenAuth.classList.remove('hidden');
            sideMenuBtnOpenAdmin.classList.remove('hidden');
            sideMenuBtnLogout.classList.add('hidden');
        }
    }


    function enterUser(user) {
        setCurrentDemoUser(user);
        setAdminLoginStatus(false);
        
        $('#btnLogout').classList.remove('hidden');
        $('#btnOpenAuth').classList.add('hidden');
        $('#adminBadge').classList.add('hidden');
        $('#adminPanel').classList.add('hidden');

        // Update side menu auth buttons
        updateAuthButtonsInSideMenu(true, false);

        $all('.menu-item').forEach(m => m.classList.remove('active'));
        $('[data-view="store"]').classList.add('active'); 
        
        $('#balanceVal').textContent = `${(user.balance || 0).toLocaleString()} ƒë`;
        $('#storeBalanceVal').textContent = `${(user.balance || 0).toLocaleString()} ƒë`;
        $('#purchasedCount').textContent = user.tools ? user.tools.length : 0;
        $('#sideName').textContent = user.name;
        $('#sideEmail').textContent = user.email;
        $('#sidebarUser').textContent = `${user.name} ‚Ä¢ Online`;
        $('#regDate').textContent = new Date(user.regDate).toLocaleDateString();

        renderMyTools(user.tools || []);
        renderProfilePanel(user);
        renderUserTxTable();
        renderUserTopupRequests(); // Render user's top-up requests

        // Restore original section visibility logic (hide all then show selected)
        $all('main section').forEach(section => section.classList.add('hidden'));
        $('#storeView').classList.remove('hidden'); 

        $('#topupModal').classList.remove('active');
    }

    function enterAdmin() {
        setCurrentDemoUser(null);
        setAdminLoginStatus(true);

        $('#btnLogout').classList.remove('hidden');
        $('#btnOpenAuth').classList.add('hidden');
        $('#adminBadge').classList.remove('hidden');
        $('#adminPanel').classList.remove('hidden'); // Admin panel should be visible

        // Update side menu auth buttons
        updateAuthButtonsInSideMenu(false, true);
        
        // Restore original section visibility logic
        $all('main section').forEach(section => section.classList.add('hidden'));
        $('#adminPanel').classList.remove('hidden'); 

        $('#balanceVal').textContent = '0 ƒë';
        $('#storeBalanceVal').textContent = '0 ƒë';
        $('#purchasedCount').textContent = '0';
        $('#sideName').textContent = 'Admin';
        $('#sideEmail').textContent = 'admin';
        $('#sidebarUser').textContent = 'Admin ‚Ä¢ Online';
        $('#regDate').textContent = '-';
        $('#miniMyTools').innerHTML = '';
        
        // Initial render for admin panel
        renderAdminTopupRequests(); // Render admin top-up requests
        renderAdminPending([]);
        renderAdminHist([]);
        renderAdminUsers(); // Render users for admin

        $('#tabAdminTopupRequests').click(); // Default to top-up requests for admin
    }
    
    function logout() {
        setCurrentDemoUser(null);
        setAdminLoginStatus(false);
        showToast('ƒê√£ ƒëƒÉng xu·∫•t', 'info');
        $('#btnLogout').classList.add('hidden');
        $('#btnOpenAuth').classList.remove('hidden');
        updateAuthButtonsInSideMenu(false, false); // Update side menu auth buttons
        refreshGuestUI();
    }

    function refreshGuestUI() {
        setCurrentDemoUser(null);
        setAdminLoginStatus(false);

        $('#balanceVal').textContent = '0 ƒë';
        $('#storeBalanceVal').textContent = '0 ƒë';
        $('#purchasedCount').textContent = '0';
        $('#sideName').textContent = 'Kh√°ch';
        $('#sideEmail').textContent = 'Ch∆∞a ƒëƒÉng nh·∫≠p';
        $('#sidebarUser').textContent = 'Ch∆∞a ƒëƒÉng nh·∫≠p';
        $('#sideAvatar').textContent = 'üë§';
        $('#regDate').textContent = '-';
        $('#miniMyTools').innerHTML = '';
        $('#mytoolsList').innerHTML = '';
        $('#adminBadge').classList.add('hidden');
        $('#adminPanel').classList.add('hidden');

        // Update side menu auth buttons
        updateAuthButtonsInSideMenu(false, false);

        // Restore original section visibility logic
        $all('main section').forEach(section => section.classList.add('hidden'));
        $('#welcomeSection').classList.remove('hidden');
        
        $all('.menu-item').forEach(m => m.classList.remove('active'));
        $('[data-view="home"]').classList.add('active');
    }

    /***********************
     * RENDER FUNCTIONS (DEMO DATA)
     ***********************/
    function renderStore() {
      const storeGrid = $('#storeGrid');
      storeGrid.innerHTML = '';
      TOOLS.forEach(t => {
        const card = document.createElement('div');
        card.className = 'tool-card';
        card.innerHTML = `
          <h4>${t.name}</h4>
          <div class="muted">${t.desc}</div>
          <div class="price">${t.price.toLocaleString()} ƒë</div>
          <div class="tool-actions">
            <button type="button" class="btn btn-primary buy-btn" data-id="${t.id}" aria-label="Mua ngay ${t.name}">Mua ngay</button>
            <button type="button" class="btn btn-glass detail-btn" data-id="${t.id}" aria-label="Chi ti·∫øt ${t.name}">Chi ti·∫øt</button>
          </div>`;
        storeGrid.appendChild(card);
      });
      $all('.buy-btn').forEach(b => b.addEventListener('click', handleBuy));
      $all('.detail-btn').forEach(b => b.addEventListener('click', handleToolDetail));
    }

    function renderMyTools(toolIds) {
      const list = $('#mytoolsList');
      const miniList = $('#miniMyTools');
      list.innerHTML = '';
      miniList.innerHTML = '';

      if (toolIds.length === 0) {
        list.innerHTML = '<div class="muted">B·∫°n ch∆∞a mua tool n√†o.</div>';
        miniList.innerHTML = '<div class="muted">Ch∆∞a c√≥ tool</div>';
        return;
      }
      
      toolIds.forEach(id => {
        const t = TOOLS.find(x => x.id === id);
        if (t) {
          const row = document.createElement('div');
          row.className = 'mytool';
          row.innerHTML = `<div>${t.name}</div><div><button type="button" class='btn btn-glass dl-btn' data-id='${t.id}' aria-label="T·∫£i ${t.name}">T·∫£i</button></div>`;
          list.appendChild(row);

          const miniEl = document.createElement('div');
          miniEl.style.marginBottom = '6px';
          miniEl.innerHTML = `<small>${t.name}</small>`;
          miniList.appendChild(miniEl);
        }
      });
      
      $all('.dl-btn').forEach(b => b.addEventListener('click', e => {
        const t = TOOLS.find(x => x.id === e.target.dataset.id);
        if (t && t.downloadLink) {
          window.open(t.downloadLink, '_blank');
          showToast('ƒêang t·∫£i xu·ªëng: ' + t.name, 'success');
        } else {
          showToast('Kh√¥ng t√¨m th·∫•y link t·∫£i xu·ªëng', 'error');
        }
      }));
    }

    function renderProfilePanel(user) {
        const panel = $('#profilePanel');
        if (!user) {
            panel.innerHTML='<div class="muted">Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ xem h·ªì s∆°</div>';
            return;
        }
        panel.innerHTML = `<div style="display:flex;gap:12px;align-items:center"><div style="width:80px;height:80px;border-radius:10px;overflow:hidden"><div style="display:grid;place-items:center;height:80px" aria-hidden="true">üë§</div></div><div><div style="font-weight:900">${user.name}</div><div class='small-muted'>${user.email}</div><div class='small-muted'>ƒêƒÉng k√Ω: ${new Date(user.regDate).toLocaleDateString()}</div></div></div><div style="margin-top:12px"><strong>S·ªë d∆∞:</strong> ${(user.balance || 0).toLocaleString()} ƒë <button type="button" class='btn btn-glass' id='panelTopup' style='margin-left:8px' aria-label="N·∫°p ti·ªÅn">N·∫°p</button></div><div style="margin-top:8px"><strong>My Tools:</strong> ${(user.tools || []).length}</div><div style="margin-top:10px"><button type="button" class='btn btn-primary' id='panelEdit' aria-label="Ch·ªânh s·ª≠a h·ªì s∆°">Ch·ªânh s·ª≠a h·ªì s∆°</button></div>`;
        $('#panelTopup').addEventListener('click', () => {
            handleOpenTopupModal();
        });
        $('#panelEdit').addEventListener('click', () => {
            $('#pf_name').value = user.name;
            $('#pf_email').value = user.email;
            $('#profileModal').classList.add('active');
        });
    }

    function renderUserTxTable() {
      $('#userTxTableWrap').innerHTML = '<div class="muted">L·ªãch s·ª≠ giao d·ªãch ƒëang ho·∫°t ƒë·ªông.</div>';
    }

    // New: Render user's top-up requests
    function renderUserTopupRequests() {
        const user = getCurrentDemoUser();
        const tableWrap = $('#userTopupRequestsTableWrap');
        if (!user) {
            tableWrap.innerHTML = '<div class="muted">Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ xem y√™u c·∫ßu n·∫°p ti·ªÅn.</div>';
            return;
        }

        const requests = getTopupRequests().filter(req => req.userId === user.id);

        if (requests.length === 0) {
            tableWrap.innerHTML = '<div class="muted">B·∫°n kh√¥ng c√≥ y√™u c·∫ßu n·∫°p ti·ªÅn n√†o.</div>';
            return;
        }

        let tableHtml = `
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>S·ªë ti·ªÅn</th>
                        <th>N·ªôi dung</th>
                        <th>Ng√†y y√™u c·∫ßu</th>
                        <th>Tr·∫°ng th√°i</th>
                    </tr>
                </thead>
                <tbody>
        `;
        requests.forEach(req => {
            let statusText = '';
            let statusColor = '';
            if (req.status === 'pending') {
                statusText = 'ƒêang ch·ªù';
                statusColor = 'orange';
            } else if (req.status === 'approved') {
                statusText = 'ƒê√£ duy·ªát';
                statusColor = 'var(--brand3)';
            } else if (req.status === 'rejected') {
                statusText = 'ƒê√£ t·ª´ ch·ªëi';
                statusColor = 'var(--danger)';
            }
            tableHtml += `
                <tr>
                    <td>${req.id}</td>
                    <td>${req.amount.toLocaleString()} ƒë</td>
                    <td>${req.memo}</td>
                    <td>${new Date(req.timestamp).toLocaleDateString()}</td>
                    <td><span style="color:${statusColor}; font-weight: 600;">${statusText}</span></td>
                </tr>
            `;
        });
        tableHtml += `
                </tbody>
            </table>
        `;
        tableWrap.innerHTML = tableHtml;
    }

    function renderAdminPending(pendingRequests) {
        $('#adminPendContent').innerHTML = '<div class="muted">Ch·ª©c nƒÉng qu·∫£n l√Ω ƒë∆°n h√†ng ƒëang ho·∫°t ƒë·ªông.</div>';
    }

    function renderAdminHist(history) {
        $('#adminHistTable').innerHTML = '<div class="muted">L·ªãch s·ª≠ giao d·ªãch ƒëang ho·∫°t ƒë·ªông.</div>';
    }

    function renderAdminUsers() {
        const users = getDemoUsers();
        const tableWrap = $('#adminUsersTableWrap');
        if (users.length === 0) {
            tableWrap.innerHTML = '<div class="muted">Ch∆∞a c√≥ ng∆∞·ªùi d√πng n√†o ƒë∆∞·ª£c ƒëƒÉng k√Ω.</div>';
            return;
        }

        let tableHtml = `
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>H·ªç t√™n</th>
                        <th>Email</th>
                        <th>S·ªë d∆∞</th>
                        <th>ƒêƒÉng k√Ω</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
        `;
        users.forEach(user => {
            tableHtml += `
                <tr>
                    <td>${user.id}</td>
                    <td>${user.name}</td>
                    <td>${user.email}</td>
                    <td>${(user.balance || 0).toLocaleString()} ƒë</td>
                    <td>${new Date(user.regDate).toLocaleDateString()}</td>
                    <td>
                        <button type="button" class="btn btn-glass btn-small edit-user-btn" data-id="${user.id}" aria-label="S·ª≠a ng∆∞·ªùi d√πng ${user.name}">S·ª≠a</button>
                    </td>
                </tr>
            `;
        });
        tableHtml += `
                </tbody>
            </table>
        `;
        tableWrap.innerHTML = tableHtml;

        $all('.edit-user-btn').forEach(button => {
            button.addEventListener('click', handleAdminEditUser);
        });
    }

    // New: Render admin's view of top-up requests
    function renderAdminTopupRequests() {
        const requests = getTopupRequests();
        const tableWrap = $('#topupRequestsTableWrap');
        if (requests.length === 0) {
            tableWrap.innerHTML = '<div class="muted">Kh√¥ng c√≥ y√™u c·∫ßu n·∫°p ti·ªÅn n√†o ƒëang ch·ªù.</div>';
            return;
        }

        let tableHtml = `
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>User Email</th>
                        <th>S·ªë ti·ªÅn</th>
                        <th>N·ªôi dung</th>
                        <th>Ng√†y y√™u c·∫ßu</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
        `;
        requests.forEach(req => {
            const user = getDemoUsers().find(u => u.id === req.userId);
            const userEmail = user ? user.email : 'N/A';
            
            let statusText = '';
            let statusColor = '';
            if (req.status === 'pending') {
                statusText = 'ƒêang ch·ªù';
                statusColor = 'orange';
            } else if (req.status === 'approved') {
                statusText = 'ƒê√£ duy·ªát';
                statusColor = 'var(--brand3)';
            } else if (req.status === 'rejected') {
                statusText = 'ƒê√£ t·ª´ ch·ªëi';
                statusColor = 'var(--danger)';
            }

            tableHtml += `
                <tr>
                    <td>${req.id}</td>
                    <td>${userEmail}</td>
                    <td>${req.amount.toLocaleString()} ƒë</td>
                    <td>${req.memo}</td>
                    <td>${new Date(req.timestamp).toLocaleDateString()}</td>
                    <td><span style="color:${statusColor}; font-weight: 600;">${statusText}</span></td>
                    <td>
            `;
            if (req.status === 'pending') {
                tableHtml += `
                        <button type="button" class="btn btn-success btn-small approve-topup-btn" data-id="${req.id}" data-userid="${req.userId}" data-amount="${req.amount}" aria-label="Duy·ªát y√™u c·∫ßu n·∫°p ti·ªÅn">Duy·ªát</button>
                        <button type="button" class="btn btn-danger btn-small reject-topup-btn" data-id="${req.id}" data-userid="${req.userId}" aria-label="T·ª´ ch·ªëi y√™u c·∫ßu n·∫°p ti·ªÅn">T·ª´ ch·ªëi</button>
                `;
            } else {
                tableHtml += `<button type="button" class="btn btn-glass btn-small" disabled>ƒê√£ x·ª≠ l√Ω</button>`;
            }
            tableHtml += `
                    </td>
                </tr>
            `;
        });
        tableHtml += `
                </tbody>
            </table>
        `;
        tableWrap.innerHTML = tableHtml;

        $all('.approve-topup-btn').forEach(button => {
            button.addEventListener('click', handleApproveTopup);
        });
        $all('.reject-topup-btn').forEach(button => {
            button.addEventListener('click', handleRejectTopup);
        });
    }


    let visitorMap = null;
    let totalVisitsMarker = null; // New global for the dynamic marker
    const centralMapLocation = [21.0285, 105.8542]; // Hanoi, Vietnam for central marker

    function renderStats() {
        const totalVisitsEl = $('#totalVisits');
        totalVisitsEl.textContent = currentVisits.toLocaleString();
        
        // Add pulse animation for totalVisits
        totalVisitsEl.classList.remove('pulse-animation'); // Remove to re-trigger
        void totalVisitsEl.offsetWidth; // Trigger reflow
        totalVisitsEl.classList.add('pulse-animation');

        $('#mapLoader').classList.remove('hidden');

        if (!visitorMap) { // Initialize map only once
            const mapEl = $('#visitorMap');
            visitorMap = L.map(mapEl).setView(centralMapLocation, 5);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(visitorMap);

            demoVisitorLocations.forEach(loc => {
                L.marker([loc.lat, loc.lon]).addTo(visitorMap)
                    .bindPopup(`L∆∞·ª£t truy c·∫≠p gi·∫£ t·ª´: ${loc.city || 'N/A'}`);
            });
        }

        // Update or create the dynamic total visits marker
        if (!totalVisitsMarker) {
            totalVisitsMarker = L.marker(centralMapLocation).addTo(visitorMap);
            totalVisitsMarker.bindPopup(`<strong style="font-size:1.1rem">T·ªïng l∆∞·ª£t truy c·∫≠p: ${currentVisits.toLocaleString()}</strong>`, { autoClose: false, closeButton: false }).openPopup();
        } else {
            totalVisitsMarker.setPopupContent(`<strong style="font-size:1.1rem">T·ªïng l∆∞·ª£t truy c·∫≠p: ${currentVisits.toLocaleString()}</strong>`).openPopup();
        }

        setTimeout(() => {
            $('#mapLoader').classList.add('hidden');
        }, 1000);
    }

    /***********************
     * EVENT HANDLERS (PLACEHOLDER/DEMO LOGIC)
     ***********************/
    $('#btnOpenAuth').addEventListener('click',()=>openAuth('login'));
    $('#closeAuth').addEventListener('click',()=>$('#authModal').classList.remove('active'));
    $('#tabLogin').addEventListener('click',()=>openAuth('login'));
    $('#tabRegister').addEventListener('click',()=>openAuth('register'));
    $('#goRegister').addEventListener('click',(e)=>{ e.preventDefault(); openAuth('register') });
    $('#btnOpenAdmin').addEventListener('click',()=>$('#adminLoginModal').classList.add('active'));
    $('#closeAdminLogin').addEventListener('click',()=>$('#adminLoginModal').classList.remove('active'));
    $('#btnLogout').addEventListener('click', logout);
    $('#viewTransactions').addEventListener('click',()=>$('#txModal').classList.add('active'));
    $('#closeTx').addEventListener('click',()=>$('#txModal').classList.remove('active'));
    $('#closeTopup').addEventListener('click',()=>$('#topupModal').classList.remove('active'));
    $('#closeProfile').addEventListener('click',()=>$('#profileModal').classList.remove('active'));
    $('#closeToolDetail').addEventListener('click',()=>$('#toolDetailModal').classList.remove('active'));
    $('#closeAdminEditUser').addEventListener('click',()=>$('#adminEditUserModal').classList.remove('active'));

    // New: Side menu auth buttons event listeners
    $('#sideMenuBtnOpenAuth').addEventListener('click', () => {
        openAuth('login');
        // Close side menu after opening modal
        $('#sideMenu').classList.remove('active');
        $('#mobileOverlay').classList.remove('active');
    });
    $('#sideMenuBtnOpenAdmin').addEventListener('click', () => {
        $('#adminLoginModal').classList.add('active');
        // Close side menu after opening modal
        $('#sideMenu').classList.remove('active');
        $('#mobileOverlay').classList.remove('active');
    });
    $('#sideMenuBtnLogout').addEventListener('click', () => {
        logout();
        // Close side menu after logging out
        $('#sideMenu').classList.remove('active');
        $('#mobileOverlay').classList.remove('active');
    });

    function handleOpenTopupModal(){
      const currentUserData = getCurrentDemoUser();
      if (!currentUserData) {
        showToast('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ n·∫°p ti·ªÅn','error');
        openAuth('login');
        return;
      }
      const userMemo = 'nap_tien_'+(currentUserData.email ? currentUserData.email.split('@')[0] : 'guest');
      $('#bankMemo').textContent = userMemo;
      $('#tp_content').value = userMemo;
      $('#tp_amount').value = '';
      updateQRCode();
      $('#topupModal').classList.add('active');
    }
    $('#openTopup').addEventListener('click', handleOpenTopupModal);
    $('#btnTopupFromStore').addEventListener('click', handleOpenTopupModal);

    $all('[data-copy]').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const sel = btn.getAttribute('data-copy'); const el = document.querySelector(sel); const txt = el?.textContent || '';
        const tempInput = document.createElement('textarea');
        tempInput.value = txt;
        document.body.appendChild(tempInput);
        tempInput.select();
        document.execCommand('copy');
        document.body.removeChild(tempInput);
        showToast('ƒê√£ copy: '+txt,'success');
      })
    });

    function updateQRCode(){
      const acc = $('#bankAcc').textContent;
      const memo = $('#tp_content').value.trim();
      const amount = $('#tp_amount').value || '0';
      const qrData = `https://api.vietqr.io/image/BIDV-${acc}-print.png?amount=${amount}&addInfo=${encodeURIComponent(memo)}`;
      $('#qrImg').src = qrData;
      $('#qrImg').onerror = () => {
          $('#qrImg').src = `https://placehold.co/180x180/0a4e9b/fff?text=QR+Demo`;
          showToast('Kh√¥ng th·ªÉ t·∫£i QR Code th·∫≠t, hi·ªÉn th·ªã demo.', 'warn');
      };
    }

    $('#tp_amount').addEventListener('input', updateQRCode);
    $('#tp_content').addEventListener('input', updateQRCode);
    $('#quickContact').addEventListener('click',()=>{ showToast('Ch·ª©c nƒÉng li√™n h·ªá nhanh ƒëang ho·∫°t ƒë·ªông.','info'); });

    // Modified: doTopupRequest now creates a pending request
    $('#doTopupRequest').addEventListener('click', () => {
        const currentUserData = getCurrentDemoUser();
        if (!currentUserData) {
            showToast('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ t·∫°o y√™u c·∫ßu n·∫°p ti·ªÅn.', 'error');
            return;
        }

        const amount = parseFloat($('#tp_amount').value);
        const memo = $('#tp_content').value.trim();

        if (isNaN(amount) || amount <= 0) {
            showToast('Vui l√≤ng nh·∫≠p s·ªë ti·ªÅn h·ª£p l·ªá.', 'error');
            return;
        }
        if (!memo) {
            showToast('Vui l√≤ng nh·∫≠p n·ªôi dung chuy·ªÉn kho·∫£n.', 'error');
            return;
        }

        let requests = getTopupRequests();
        const newRequestId = requests.length > 0 ? Math.max(...requests.map(r => r.id)) + 1 : 1;

        const newRequest = {
            id: newRequestId,
            userId: currentUserData.id,
            amount: amount,
            memo: memo,
            timestamp: new Date().toISOString(),
            status: 'pending' // Initial status
        };
        requests.push(newRequest);
        setTopupRequests(requests);

        showToast('Y√™u c·∫ßu n·∫°p ti·ªÅn c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c g·ª≠i. Vui l√≤ng ch·ªù Admin duy·ªát.', 'info');
        $('#topupModal').classList.remove('active');
        renderUserTopupRequests(); // Update user's view of requests
        if (getAdminLoginStatus()) { // If admin is logged in, update their view too
            renderAdminTopupRequests();
        }
    });


    $('#doRegister').addEventListener('click', () => {
        const name = $('#rg_name').value.trim();
        const email = $('#rg_email').value.trim();
        const password = $('#rg_pass').value;
        const password2 = $('#rg_pass2').value;
        const err = $('#regErr');
        err.style.display = 'none';

        if (!name || !email || password.length < 6) { err.textContent = 'Vui l√≤ng ƒëi·ªÅn ƒë·ªß & m·∫≠t kh·∫©u >= 6'; err.style.display = 'block'; shake($('#authModal .modal-card')); return; }
        if (password !== password2) { err.textContent = 'M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp'; err.style.display = 'block'; shake($('#authModal .modal-card')); return; }

        let users = getDemoUsers();
        if (users.find(u => u.email === email)) {
            err.textContent = 'Email ƒë√£ t·ªìn t·∫°i.'; err.style.display = 'block'; shake($('#authModal .modal-card')); return;
        }

        const newUser = {
            id: users.length > 0 ? Math.max(...users.map(u => u.id)) + 1 : 1, // Generate unique ID
            name,
            email,
            password,
            balance: 100000,
            tools: [],
            regDate: new Date().toISOString()
        };
        users.push(newUser);
        setDemoUsers(users);

        showToast('ƒêƒÉng k√Ω t√†i kho·∫£n th√†nh c√¥ng. Vui l√≤ng ƒëƒÉng nh·∫≠p', 'success');
        $('#rg_name').value = ''; $('#rg_email').value = ''; $('#rg_pass').value = ''; $('#rg_pass2').value = '';
        openAuth('login');
    });

    $('#doLogin').addEventListener('click', () => {
        const email = $('#li_user').value.trim();
        const password = $('#li_pass').value;
        const err = $('#loginErr');
        err.style.display = 'none';

        if (!email || !password) { err.textContent = 'Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß'; err.style.display = 'block'; shake($('#authModal .modal-card')); return; }

        const users = getDemoUsers();
        const user = users.find(u => (u.email === email || u.name === email) && u.password === password);

        if (user) {
            showToast('ƒêƒÉng nh·∫≠p sever th√†nh c√¥ng', 'success');
            $('#authModal').classList.remove('active');
            enterUser(user);
        } else {
            err.textContent = 'Sai t√†i kho·∫£n ho·∫∑c m·∫≠t kh·∫©u ƒë√£ ƒëƒÉng k√≠.'; err.style.display = 'block'; shake($('#authModal .modal-card'));
        }
    });

    $('#doAdminLogin').addEventListener('click', () => {
        const username = $('#ad_user').value.trim();
        const password = $('#ad_pass').value;
        if (username === 'admin' && password === 'DANGKHOA_DEV_MXH_2025') {
            enterAdmin();
            showToast('ƒêƒÉng nh·∫≠p Admin sever th√†nh c√¥ng!','success');
            $('#adminLoginModal').classList.remove('active');
        } else {
            showToast('Sai th√¥ng tin admin demo.','error');
            shake($('#adminLoginModal .modal-card'));
        }
    });

    $('#saveProfile').addEventListener('click', () => {
        const name = $('#pf_name').value.trim();
        const email = $('#pf_email').value.trim();
        const currentUserData = getCurrentDemoUser();
        
        if (!name || !email || !currentUserData) { showToast('ƒêi·ªÅn ƒë·ªß th√¥ng tin', 'error'); return; }

        let users = getDemoUsers();
        const userIndex = users.findIndex(u => u.email === currentUserData.email);
        if (userIndex !== -1) {
            users[userIndex].name = name;
            users[userIndex].email = email;
            setDemoUsers(users);
            setCurrentDemoUser(users[userIndex]);
            showToast('L∆∞u h·ªì s∆° th√†nh c√¥ng', 'success');
            $('#profileModal').classList.remove('active');
            enterUser(users[userIndex]);
        } else {
             showToast('Kh√¥ng t√¨m th·∫•y user ƒë·ªÉ c·∫≠p nh·∫≠t.','error');
        }
    });

    $('#btnIncreaseVisits').addEventListener('click', () => {
        const amount = Number($('#manualVisits').value || 0);
        if (amount > 0) {
            currentVisits += amount;
            localStorage.setItem(LS_VISITS_KEY, currentVisits.toString());
            showToast(`ƒê√£ tƒÉng th√™m ${amount} l∆∞·ª£t truy c·∫≠p demo. T·ªïng: ${currentVisits}`, 'success');
            renderStats(); // Re-render stats to update map and pulse animation
        } else {
            showToast('S·ªë l∆∞·ª£ng kh√¥ng h·ª£p l·ªá.','error');
        }
    });

    function handleBuy(e){
      const currentUserData = getCurrentDemoUser();
      if (!currentUserData) {
          showToast('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ mua tool.','error');
          openAuth('login');
          return;
      }
      const id = e.target.dataset.id;
      const tool = TOOLS.find(t => t.id === id);

      if (currentUserData.balance < tool.price) {
          showToast('S·ªë d∆∞ kh√¥ng ƒë·ªß ƒë·ªÉ mua tool n√†y.', 'error');
          return;
      }

      currentUserData.balance -= tool.price;
      currentUserData.tools = currentUserData.tools || [];
      if (!currentUserData.tools.includes(tool.id)) {
          currentUserData.tools.push(tool.id);
      }

      let users = getDemoUsers();
      const userIndex = users.findIndex(u => u.email === currentUserData.email);
      if (userIndex !== -1) {
          users[userIndex] = currentUserData;
          setDemoUsers(users);
          setCurrentDemoUser(currentUserData);
          showToast(`B·∫°n ƒë√£ mua ${tool.name} th√†nh c√¥ng!`, 'success');
          enterUser(currentUserData);
      } else {
           showToast('L·ªói khi c·∫≠p nh·∫≠t th√¥ng tin user.','error');
      }
    }

    // Function to handle opening tool detail modal
    function handleToolDetail(e) {
        const toolId = e.target.dataset.id;
        const tool = TOOLS.find(t => t.id === toolId);
        if (tool) {
            $('#td_name').textContent = tool.name;
            $('#td_fullDesc').textContent = tool.fullDesc;
            $('#td_price').textContent = tool.price.toLocaleString() + ' ƒë';
            
            const tdBuyBtn = $('#td_buyBtn');
            tdBuyBtn.setAttribute('data-id', tool.id);
            // Remove existing event listener to prevent multiple calls
            tdBuyBtn.removeEventListener('click', handleBuyFromDetail);
            tdBuyBtn.addEventListener('click', handleBuyFromDetail);

            const tdViewMoreLink = $('#td_viewMoreLink');
            if (tool.detailLink) {
                tdViewMoreLink.href = tool.detailLink;
                tdViewMoreLink.classList.remove('hidden');
            } else {
                tdViewMoreLink.classList.add('hidden');
            }

            $('#toolDetailModal').classList.add('active');
        } else {
            showToast('Kh√¥ng t√¨m th·∫•y th√¥ng tin tool.', 'error');
        }
    }

    // Handle buy action from the detail modal
    function handleBuyFromDetail(e) {
        // This will call the existing handleBuy logic after closing the modal
        $('#toolDetailModal').classList.remove('active');
        handleBuy(e); 
    }

    // Handle Admin Edit User click
    function handleAdminEditUser(e) {
        const userId = parseInt(e.target.dataset.id);
        const users = getDemoUsers();
        const userToEdit = users.find(u => u.id === userId);

        if (userToEdit) {
            $('#aeu_id').value = userToEdit.id;
            $('#aeu_name').value = userToEdit.name;
            $('#aeu_email').value = userToEdit.email;
            $('#aeu_balance').value = userToEdit.balance;
            $('#adminEditUserModal').classList.add('active');
        } else {
            showToast('Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng ƒë·ªÉ ch·ªânh s·ª≠a.', 'error');
        }
    }

    // Handle saving changes from Admin Edit User modal
    $('#doAdminEditUser').addEventListener('click', () => {
        const userId = parseInt($('#aeu_id').value);
        const newName = $('#aeu_name').value.trim();
        const newEmail = $('#aeu_email').value.trim();
        const newBalance = parseFloat($('#aeu_balance').value);

        if (!newName || !newEmail || isNaN(newBalance) || newBalance < 0) {
            showToast('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß v√† ƒë√∫ng ƒë·ªãnh d·∫°ng th√¥ng tin ng∆∞·ªùi d√πng.', 'error');
            return;
        }

        let users = getDemoUsers();
        const userIndex = users.findIndex(u => u.id === userId);

        if (userIndex !== -1) {
            users[userIndex].name = newName;
            users[userIndex].email = newEmail;
            users[userIndex].balance = newBalance;
            setDemoUsers(users);

            // If the edited user is the currently logged-in user, update their session too
            const currentUser = getCurrentDemoUser();
            if (currentUser && currentUser.id === userId) {
                setCurrentDemoUser(users[userIndex]);
                enterUser(users[userIndex]); // Re-render user UI
            } else {
                // If admin is editing, but not the current user, just refresh admin user list
                renderAdminUsers(); 
            }
            showToast(`ƒê√£ c·∫≠p nh·∫≠t th√¥ng tin ng∆∞·ªùi d√πng: ${newName}`, 'success');
            $('#adminEditUserModal').classList.remove('active');
        } else {
            showToast('Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng ƒë·ªÉ c·∫≠p nh·∫≠t.', 'error');
        }
    });

    // Handle deleting user from Admin Edit User modal
    $('#doAdminDeleteUserFromEditModal').addEventListener('click', () => {
        const userId = parseInt($('#aeu_id').value);
        let users = getDemoUsers();
        const initialUserCount = users.length;

        users = users.filter(u => u.id !== userId);
        setDemoUsers(users);

        if (users.length < initialUserCount) {
            showToast('ƒê√£ x√≥a ng∆∞·ªùi d√πng th√†nh c√¥ng!', 'success');
            $('#adminEditUserModal').classList.remove('active');
            renderAdminUsers(); // Re-render admin user list

            // Check if the deleted user was the currently logged-in user
            const currentUser = getCurrentDemoUser();
            if (currentUser && currentUser.id === userId) {
                logout(); // Log out the deleted user
                showToast('Ng∆∞·ªùi d√πng b·∫°n v·ª´a x√≥a ƒë√£ ƒëƒÉng xu·∫•t.','warn');
            }
        } else {
            showToast('Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng ƒë·ªÉ x√≥a.', 'error');
        }
    });

    // New: Handle Approve Topup Request
    function handleApproveTopup(e) {
        const requestId = parseInt(e.target.dataset.id);
        const userId = parseInt(e.target.dataset.userid);
        const amount = parseFloat(e.target.dataset.amount);

        let requests = getTopupRequests();
        const requestIndex = requests.findIndex(req => req.id === requestId);

        if (requestIndex !== -1) {
            requests[requestIndex].status = 'approved';
            setTopupRequests(requests);

            let users = getDemoUsers();
            const userIndex = users.findIndex(u => u.id === userId);
            if (userIndex !== -1) {
                users[userIndex].balance += amount;
                setDemoUsers(users);

                // If the approved user is currently logged in, update their UI
                const currentUser = getCurrentDemoUser();
                if (currentUser && currentUser.id === userId) {
                    setCurrentDemoUser(users[userIndex]);
                    enterUser(users[userIndex]); // Re-render user UI
                    showToast(`Y√™u c·∫ßu n·∫°p ${amount.toLocaleString()}ƒë c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c duy·ªát!`, 'success');
                } else {
                    showToast(`ƒê√£ duy·ªát y√™u c·∫ßu n·∫°p ${amount.toLocaleString()}ƒë cho user ID ${userId}.`, 'success');
                }
            } else {
                showToast('L·ªói: Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng ƒë·ªÉ c·ªông ti·ªÅn.', 'error');
            }
            renderAdminTopupRequests(); // Re-render admin's view
            renderUserTopupRequests(); // Also re-render user's view if they are on that page
        } else {
            showToast('Kh√¥ng t√¨m th·∫•y y√™u c·∫ßu n·∫°p ti·ªÅn ƒë·ªÉ duy·ªát.', 'error');
        }
    }

    // New: Handle Reject Topup Request
    function handleRejectTopup(e) {
        const requestId = parseInt(e.target.dataset.id);
        const userId = parseInt(e.target.dataset.userid); // Get userId to notify the user

        let requests = getTopupRequests();
        const requestIndex = requests.findIndex(req => req.id === requestId);

        if (requestIndex !== -1) {
            requests[requestIndex].status = 'rejected';
            setTopupRequests(requests);
            
            // Notify the user if they are logged in
            const currentUser = getCurrentDemoUser();
            if (currentUser && currentUser.id === userId) {
                showToast(`Y√™u c·∫ßu n·∫°p ti·ªÅn c·ªßa b·∫°n ƒë√£ b·ªã t·ª´ ch·ªëi. Vui l√≤ng li√™n h·ªá h·ªó tr·ª£ n·∫øu c√≥ th·∫Øc m·∫Øc.`, 'error');
                enterUser(currentUser); // Re-render to update their request status display
            } else {
                 showToast(`ƒê√£ t·ª´ ch·ªëi y√™u c·∫ßu n·∫°p ti·ªÅn ID ${requestId} cho user ID ${userId}.`, 'warn');
            }
            renderAdminTopupRequests(); // Re-render admin's view
            renderUserTopupRequests(); // Also re-render user's view if they are on that page
        } else {
            showToast('Kh√¥ng t√¨m th·∫•y y√™u c·∫ßu n·∫°p ti·ªÅn ƒë·ªÉ t·ª´ ch·ªëi.', 'error');
        }
    }


    // Tab handling for Admin Panel
    // New tab for admin: Topup Requests
    $('#tabAdminTopupRequests').addEventListener('click', () => {
        $('#tabAdminTopupRequests').classList.add('active');
        $('#tabPend').classList.remove('active');
        $('#tabHist').classList.remove('active');
        $('#tabUsers').classList.remove('active');
        $('#tabStats').classList.remove('active');

        $('#adminTopupRequestsContent').classList.remove('hidden');
        $('#adminPendContent').classList.add('hidden');
        $('#adminHistContent').classList.add('hidden');
        $('#adminUsersContent').classList.add('hidden');
        $('#adminStatsContent').classList.add('hidden');
        renderAdminTopupRequests();
    });

    $('#tabPend').addEventListener('click', () => {
      $('#tabPend').classList.add('active'); $('#tabHist').classList.remove('active'); $('#tabUsers').classList.remove('active'); $('#tabStats').classList.remove('active'); $('#tabAdminTopupRequests').classList.remove('active');
      $('#adminPendContent').classList.remove('hidden'); $('#adminHistContent').classList.add('hidden'); $('#adminUsersContent').classList.add('hidden'); $('#adminStatsContent').classList.add('hidden'); $('#adminTopupRequestsContent').classList.add('hidden');
    });
    $('#tabHist').addEventListener('click', () => {
      $('#tabHist').classList.add('active'); $('#tabPend').classList.remove('active'); $('#tabUsers').classList.remove('active'); $('#tabStats').classList.remove('active'); $('#tabAdminTopupRequests').classList.remove('active');
      $('#adminHistContent').classList.remove('hidden'); $('#adminPendContent').classList.add('hidden'); $('#adminUsersContent').classList.add('hidden'); $('#adminStatsContent').classList.add('hidden'); $('#adminTopupRequestsContent').classList.add('hidden');
    });
    $('#tabUsers').addEventListener('click', () => { // NEW TAB LISTENER
      $('#tabUsers').classList.add('active'); $('#tabPend').classList.remove('active'); $('#tabHist').classList.remove('active'); $('#tabStats').classList.remove('active'); $('#tabAdminTopupRequests').classList.remove('active');
      $('#adminUsersContent').classList.remove('hidden'); $('#adminPendContent').classList.add('hidden'); $('#adminHistContent').classList.add('hidden'); $('#adminStatsContent').classList.add('hidden'); $('#adminTopupRequestsContent').classList.add('hidden');
      renderAdminUsers(); // Render users when this tab is active
    });
    $('#tabStats').addEventListener('click', () => {
      $('#tabStats').classList.add('active'); $('#tabPend').classList.remove('active'); $('#tabHist').classList.remove('active'); $('#tabUsers').classList.remove('active'); $('#tabAdminTopupRequests').classList.remove('active');
      $('#adminStatsContent').classList.remove('hidden'); $('#adminPendContent').classList.add('hidden'); $('#adminHistContent').classList.add('hidden'); $('#adminUsersContent').classList.add('hidden'); $('#adminTopupRequestsContent').classList.add('hidden');
      renderStats();
    });

    // Navigation and section toggles
    $all('.menu-item').forEach(it => it.addEventListener('click', (e) => {
        e.preventDefault();
        const view = it.dataset.view;
        const isHeaderNav = it.closest('.header-nav-links');

        $all('.side-menu .menu-item').forEach(m => m.classList.remove('active'));
        $all('.header-nav-links .menu-item').forEach(m => m.classList.remove('active'));

        if (isHeaderNav) {
            it.classList.add('active');
            $(`.side-menu .menu-item[data-view="${view}"]`)?.classList.add('active');
        } else {
            it.classList.add('active');
            $(`.header-nav-links .menu-item[data-view="${view}"]`)?.classList.add('active');
        }
        
        $all('main section').forEach(section => section.classList.add('hidden')); // Hide all sections
        $('#topupModal').classList.remove('active'); // Close modals on navigation
        $('#toolDetailModal').classList.remove('active');
        $('#adminEditUserModal').classList.remove('active');


        if (view === 'home') {
            $('#welcomeSection').classList.remove('hidden');
        } else if (view === 'store') {
            $('#storeView').classList.remove('hidden');
        } else if (view === 'mytools') {
            $('#mytoolsView').classList.remove('hidden');
        } else if (view === 'profile') {
            $('#profileView').classList.remove('hidden');
        } else if (view === 'tx') {
            $('#txView').classList.remove('hidden');
            renderUserTopupRequests(); // Ensure user topup requests are rendered here
        } else if (view === 'topup') {
            handleOpenTopupModal(); // This will show the modal, not a section
        } else if (view === 'stats') {
            $('#statsView').classList.remove('hidden');
            renderStats();
        } else if (view === 'contact') {
            $('#contactView').classList.remove('hidden');
        } else if (view === 'admin') {
             $('#adminPanel').classList.remove('hidden');
             renderAdminTopupRequests(); // Ensure admin topup requests are rendered when admin panel is opened
        }

        if (view !== 'stats') {
            $('#mapLoader').classList.add('hidden');
        }

        if (window.innerWidth < 1200) {
            sideMenu.classList.remove('active');
            mobileOverlay.classList.remove('active');
        }
    }));

    // Event listener for banner Projects button (now opens register)
    $('#bannerProjectsBtn').addEventListener('click', (e) => {
        e.preventDefault();
        openAuth('register');
    });

    // Event listener for banner Contact button
    $('#bannerContactBtn').addEventListener('click', (e) => {
        e.preventDefault();
        $all('.menu-item').forEach(m => m.classList.remove('active'));
        $('[data-view="contact"]').classList.add('active');
        
        $all('main section').forEach(section => section.classList.add('hidden')); // Hide all sections
        $('#contactView').classList.remove('hidden'); // Show contact view
        
        // Hide other modals
        $('#topupModal').classList.remove('active');
        $('#toolDetailModal').classList.remove('active');
        $('#adminEditUserModal').classList.remove('active');

        if (window.innerWidth < 1200) {
            sideMenu.classList.remove('active');
            mobileOverlay.classList.remove('active');
        }
    });


    // Send Contact Email functionality
    $('#sendContactEmail').addEventListener('click', () => {
        const name = $('#contactName').value.trim();
        const email = $('#contactEmail').value.trim();
        const subject = $('#contactSubject').value.trim();
        const message = $('#contactMessage').value.trim();

        if (!name || !email || !subject || !message) {
            showToast('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß c√°c tr∆∞·ªùng th√¥ng tin!', 'error');
            return;
        }

        const recipientEmail = 'nkhoa3906@gmail.com';
        const mailtoLink = `mailto:${recipientEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(`Xin ch√†o, t√™n t√¥i l√† ${name} (${email}).\n\n${message}\n\n`)}`;
        
        window.open(mailtoLink, '_blank');
        showToast('ƒêang m·ªü ·ª©ng d·ª•ng email c·ªßa b·∫°n...', 'info');

        // Clear the form after attempting to send
        $('#contactName').value = '';
        $('#contactEmail').value = '';
        $('#contactSubject').value = '';
        $('#contactMessage').value = '';
    });


    function openAuth(mode='login'){
      $('#authModal').classList.add('active');
      $('#loginFormContent').classList.toggle('hidden', mode !== 'login');
      $('#registerFormContent').classList.toggle('hidden', mode !== 'register');
      $('#tabLogin').classList.toggle('active', mode === 'login');
      $('#tabRegister').classList.toggle('active', mode === 'login' ? false : true);

      if(mode === 'login'){
          $('#li_user').value = 'demo@user.com';
          $('#li_pass').value = '123456';
      } else {
          $('#rg_name').value = '';
          $('#rg_email').value = '';
          $('#rg_pass').value = '';
          $('#rg_pass2').value = '';
      }
    }
    
    function trackVisit() {
        currentVisits = parseInt(localStorage.getItem(LS_VISITS_KEY) || '0');
        if (sessionStorage.getItem('session_visited_flag') === null) {
            currentVisits += 1;
            localStorage.setItem(LS_VISITS_KEY, currentVisits.toString());
            sessionStorage.setItem('session_visited_flag', 'true');
        }
    }

    // Particle Animation on Canvas
    const canvas = document.getElementById('bannerCanvas');
    const ctx = canvas.getContext('2d');
    let particles = [];
    const particleCount = 60;
    const maxLineDistance = 120; // Max distance for lines

    // Particle class
    class Particle {
        constructor(x, y, radius, color) {
            this.x = x;
            this.y = y;
            this.radius = radius;
            this.color = color;
            this.vx = (Math.random() - 0.5) * 0.5; // Slower movement
            this.vy = (Math.random() - 0.5) * 0.5;
            this.alpha = Math.random() * 0.7 + 0.3; // Random opacity
        }

        draw() {
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
            ctx.fillStyle = this.color;
            ctx.globalAlpha = this.alpha;
            ctx.shadowBlur = this.radius * 2; // Glow effect
            ctx.shadowColor = this.color;
            ctx.fill();
            ctx.globalAlpha = 1;
            ctx.shadowBlur = 0; // Reset shadow
        }

        update() {
            this.x += this.vx;
            this.y += this.vy;

            // Bounce off walls
            if (this.x + this.radius > canvas.width || this.x - this.radius < 0) {
                this.vx *= -1;
            }
            if (this.y + this.radius > canvas.height || this.y - this.radius < 0) {
                this.vy *= -1;
            }
        }
    }

    // Initialize particles
    function initParticles() {
        particles = [];
        for (let i = 0; i < particleCount; i++) {
            const x = Math.random() * canvas.width;
            const y = Math.random() * canvas.height;
            const radius = Math.random() * 1.5 + 1; // Smaller particles
            particles.push(new Particle(x, y, radius, 'var(--particle-color)'));
        }
    }

    // Connect particles with lines
    function connectParticles() {
        for (let i = 0; i < particles.length; i++) {
            for (let j = i; j < particles.length; j++) {
                const p1 = particles[i];
                const p2 = particles[j];
                const distance = Math.sqrt((p1.x - p2.x)**2 + (p1.y - p2.y)**2);

                if (distance < maxLineDistance) {
                    ctx.beginPath();
                    ctx.moveTo(p1.x, p1.y);
                    ctx.lineTo(p2.x, p2.y);
                    ctx.strokeStyle = 'var(--line-color)';
                    ctx.lineWidth = 0.5;
                    ctx.globalAlpha = 1 - (distance / maxLineDistance);
                    ctx.stroke();
                    ctx.globalAlpha = 1;
                }
            }
        }
    }

    // Animation loop
    function animateBanner() {
        requestAnimationFrame(animateBanner);
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        connectParticles();

        particles.forEach(p => {
            p.update();
            p.draw();
        });
    }

    // Handle canvas resize
    function resizeCanvas() {
        const container = canvas.parentElement;
        canvas.width = container.clientWidth;
        canvas.height = container.clientHeight;
        initParticles();
    }


    /***********************
     * INIT
     ***********************/
    window.addEventListener('load', async () => {
        $('#fYear').textContent = new Date().getFullYear();
        renderStore();
        trackVisit();
        
        const loggedInUser = getCurrentDemoUser();
        const loggedInAdmin = getAdminLoginStatus();

        if (loggedInUser) {
            enterUser(loggedInUser);
            showToast(`Ch√†o m·ª´ng tr·ªü l·∫°i, ${loggedInUser.name}!`, 'info');
        } else if (loggedInAdmin) {
            enterAdmin();
            showToast('Ch√†o m·ª´ng tr·ªü l·∫°i, Admin!', 'info');
        } else {
            refreshGuestUI();
        }

        const themeToggle=$('#themeToggle');
        themeToggle.checked = localStorage.getItem('DK_THEME')==='light';
        document.documentElement.setAttribute('data-theme', themeToggle.checked? 'light':'dark');
        themeToggle.addEventListener('change',()=>{ const t=themeToggle.checked? 'light':'dark'; document.documentElement.setAttribute('data-theme',t); localStorage.setItem('DK_THEME', t) })

        $('#btnOpenMobileMenu').addEventListener('click', () => { 
            $('#sideMenu').classList.add('active'); 
            $('#mobileOverlay').classList.add('active'); 
        });
        $('#mobileOverlay').addEventListener('click', () => { 
            $('#sideMenu').classList.remove('active'); 
            $('#mobileOverlay').classList.remove('active'); 
        });

        // Initialize and start banner animation
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
        animateBanner();
    });
  </script>
</body>
</html>
